<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ofertas do Sertão — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="/img/logo.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-dot.online {
            background-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse 2s infinite;
        }
        .status-dot.offline {
            background-color: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Sidebar toggle styles */
        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }
        .sidebar.collapsed {
            transform: translateX(-100%);
            width: 0;
            overflow: hidden;
        }
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            transition: left 0.3s ease;
        }
        .sidebar-toggle.sidebar-open {
            left: 17rem;
        }
        .main-wrapper {
            transition: margin-left 0.3s ease;
        }
        .main-wrapper.sidebar-collapsed {
            margin-left: 0;
        }
        
        /* Category autocomplete styles */
        #category-suggestions {
            scrollbar-width: thin;
        }
        #category-suggestions::-webkit-scrollbar {
            width: 6px;
        }
        #category-suggestions::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        #category-suggestions::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        #category-suggestions::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        #category-suggestions > div:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }
        #category-suggestions > div:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar Toggle Button -->
    <button id="sidebarToggle" class="sidebar-toggle sidebar-open bg-blue-800 hover:bg-blue-700 text-white p-3 rounded-lg shadow-lg z-50">
        <i class="fas fa-bars text-lg"></i>
    </button>

    <!-- Sidebar -->
    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="sidebar w-64 bg-gradient-to-b from-blue-900 to-blue-800 text-white flex-shrink-0 overflow-y-auto fixed h-full z-40">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <img src="/img/logo.png" alt="Logo" id="main-logo" class="h-12 w-12 rounded-lg shadow-lg" />
                    <div>
                        <h1 class="text-xl font-bold">Ofertas do Sertão</h1>
                        <p class="text-xs text-blue-200">Gerenciador de Afiliados</p>
                    </div>
                </div>
                
                <nav class="space-y-2">
                    <a href="#" onclick="showTab('dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-700 hover:bg-blue-600 transition-colors">
                        <i class="fas fa-chart-line w-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/monitor" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-desktop w-5"></i>
                        <span>Monitor</span>
                        <i class="fas fa-external-link-alt text-xs ml-auto opacity-50"></i>
                    </a>
                    <a href="#" onclick="showTab('promocoes')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors relative">
                        <i class="fas fa-tags w-5"></i>
                        <span>Promoções</span>
                        <span id="sidebar-pending-badge" class="ml-auto bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </a>
                    <a href="#" onclick="showTab('postagem')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-paper-plane w-5"></i>
                        <span>Postagem</span>
                    </a>
                    <a href="#" onclick="showTab('configuracoes')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-cog w-5"></i>
                        <span>Configurações</span>
                    </a>
                    <a href="#" onclick="showTab('logs')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-list w-5"></i>
                        <span>Logs</span>
                    </a>
                    <a href="#" onclick="showTab('scripts')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-code w-5"></i>
                        <span>Scripts</span>
                    </a>
                </nav>

                <div class="mt-8 pt-6 border-t border-blue-700">
                    <button onclick="clearCache()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-red-600 hover:bg-red-500 transition-colors">
                        <i class="fas fa-trash w-5"></i>
                        <span>Limpar Cache</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div id="mainContent" class="main-wrapper flex-1 flex flex-col overflow-hidden ml-64">
            <!-- Top Bar -->
            <header class="bg-white shadow-sm px-6 py-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard</h2>
                    
                    <div class="flex items-center gap-6">
                        <!-- API Status Indicators -->
                        <div class="flex items-center gap-4 text-sm">
                            <div class="flex items-center" title="Shopee API">
                                <span class="status-dot online" id="status-shopee"></span>
                                <span class="text-gray-600">Shopee <span id="latency-shopee" class="text-xs text-gray-400"></span></span>
                            </div>
                            <div class="flex items-center" title="Mercado Livre">
                                <span class="status-dot online" id="status-ml"></span>
                                <span class="text-gray-600">ML <span id="latency-ml" class="text-xs text-gray-400"></span></span>
                            </div>
                            <div class="flex items-center" title="AliExpress">
                                <span class="status-dot online" id="status-ali"></span>
                                <span class="text-gray-600">AliExpress <span id="latency-ali" class="text-xs text-gray-400"></span></span>
                            </div>
                            <div class="flex items-center" title="Amazon">
                                <span class="status-dot online" id="status-amazon"></span>
                                <span class="text-gray-600">Amazon <span id="latency-amazon" class="text-xs text-gray-400"></span></span>
                            </div>
                            <div class="flex items-center" title="Google Gemini IA">
                                <span class="status-dot online" id="status-ai"></span>
                                <span class="text-gray-600">IA <span id="latency-ai" class="text-xs text-gray-400"></span></span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 rounded-lg font-medium">
                            <span class="status-dot online"></span>
                            <span>Bot Online</span>
                        </div>
                        
                        <!-- Notification Bell -->
                        <div class="relative">
                            <button onclick="showTab('promocoes')" class="relative p-2 text-gray-600 hover:text-blue-600 transition-colors" title="Promoções Pendentes">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Dashboard Tab -->
                <div id="tab-dashboard" class="tab-content">
                    <!-- Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Ofertas Hoje</p>
                                    <p class="text-3xl font-bold text-gray-800" id="metric-today">0</p>
                                </div>
                                <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tags text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Canais Ativos</p>
                                    <p class="text-3xl font-bold text-gray-800" id="metric-channels">0</p>
                                </div>
                                <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-satellite-dish text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Erros de Processamento</p>
                                    <p class="text-3xl font-bold text-gray-800" id="metric-errors">0</p>
                                </div>
                                <div class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Queue & Rate Limit Status -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Queue Status Card -->
                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-list-ol text-purple-500 mr-2"></i>Fila de Promoções
                                </h3>
                                <span id="queue-status-badge" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">Parado</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-600" id="queue-length">0</p>
                                    <p class="text-xs text-gray-500">Na fila</p>
                                </div>
                                <div class="text-center p-3 bg-purple-50 rounded-lg">
                                    <p class="text-2xl font-bold text-purple-600" id="queue-eta">0s</p>
                                    <p class="text-xs text-gray-500">Tempo estimado</p>
                                </div>
                            </div>
                            <div class="mt-3 flex items-center justify-between text-sm text-gray-500">
                                <span><i class="fas fa-clock mr-1"></i>Delay: <span id="queue-delay">10</span>s</span>
                                <span><i class="fas fa-hourglass-half mr-1"></i>Espera média: <span id="queue-avg-wait">0</span>s</span>
                            </div>
                        </div>

                        <!-- Rate Limit Status Card -->
                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-tachometer-alt text-orange-500 mr-2"></i>Rate Limit
                                </h3>
                                <button onclick="showTab('configuracoes'); setTimeout(() => document.getElementById('rate-limit-section')?.scrollIntoView({behavior:'smooth'}), 100)" class="text-xs text-blue-600 hover:underline">
                                    <i class="fas fa-cog mr-1"></i>Configurar
                                </button>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <div class="text-center p-3 bg-orange-50 rounded-lg">
                                    <p class="text-xl font-bold text-orange-600"><span id="rate-current">0</span>/<span id="rate-max">5</span></p>
                                    <p class="text-xs text-gray-500">Mensagens</p>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded-lg">
                                    <p class="text-xl font-bold text-orange-600" id="rate-window">60</p>
                                    <p class="text-xs text-gray-500">Janela (s)</p>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded-lg">
                                    <p class="text-xl font-bold text-orange-600" id="rate-remaining">5</p>
                                    <p class="text-xs text-gray-500">Restantes</p>
                                </div>
                                <div class="text-center p-3 bg-orange-50 rounded-lg" id="rate-cooldown-container">
                                    <p class="text-xl font-bold text-orange-600" id="rate-cooldown">0s</p>
                                    <p class="text-xs text-gray-500">Libera em</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="rate-progress" class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p class="text-xs text-gray-400 mt-1 text-center" id="rate-status-text">Disponível para enviar</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Postagens Semanais</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Categorias Mais Ativas</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-semibold mb-4">Atividade Recente</h3>
                        <div class="space-y-3" id="recentActivity">
                            <p class="text-gray-500 text-sm">Carregando...</p>
                        </div>
                    </div>
                </div>

                <!-- Promoções Pendentes Tab -->
                <div id="tab-promocoes" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Promoções Pendentes</h3>
                                <p class="text-sm text-gray-500">Promoções que precisam de aprovação manual (IA não conseguiu classificar)</p>
                            </div>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <button onclick="approveAllPending()" id="btn-approve-all-pending" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 text-sm">
                                    <i class="fas fa-check-double mr-1"></i>Aprovar Todos
                                </button>
                                <button onclick="rejectAllPending()" id="btn-reject-all-pending" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 text-sm">
                                    <i class="fas fa-times-circle mr-1"></i>Recusar Todos
                                </button>
                                <button onclick="reanalyzeAllWithAI()" id="btn-reanalyze-ai" class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                    <i class="fas fa-robot mr-1"></i>Reanalisar com IA
                                </button>
                                <button onclick="loadPendingPromotions()" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Atualizar
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="pending-empty-state" class="text-center py-12 hidden">
                            <i class="fas fa-check-circle text-6xl text-green-300 mb-4"></i>
                            <h4 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma promoção pendente!</h4>
                            <p class="text-gray-500">Todas as promoções foram processadas automaticamente pela IA.</p>
                        </div>

                        <!-- Pending Promotions List -->
                        <div id="pending-promotions-list" class="space-y-4">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Edit Promotion Modal -->
                    <div id="edit-promotion-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
                            <div class="p-6 border-b">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-bold text-gray-800">Editar Promoção</h3>
                                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                            </div>
                            <form id="edit-promotion-form" class="p-6 space-y-4">
                                <input type="hidden" id="edit-promo-id">
                                <input type="hidden" id="edit-image-path">
                                
                                <!-- Imagem da Promoção -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Imagem da Promoção</label>
                                    <div class="flex items-start gap-4">
                                        <div id="edit-image-preview-container" class="relative">
                                            <img id="edit-image-preview" src="" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-200 hidden">
                                            <div id="edit-image-placeholder" class="w-32 h-32 bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400 text-3xl"></i>
                                            </div>
                                            <button type="button" onclick="removeEditImage()" id="btn-remove-image" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full hover:bg-red-600 hidden">
                                                <i class="fas fa-times text-xs"></i>
                                            </button>
                                        </div>
                                        <div class="flex-1">
                                            <label class="cursor-pointer">
                                                <div class="px-4 py-3 bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg text-center transition-colors">
                                                    <i class="fas fa-upload text-blue-500 mb-1"></i>
                                                    <p class="text-sm text-blue-600 font-medium">Clique para enviar nova imagem</p>
                                                    <p class="text-xs text-gray-500">JPG, PNG ou GIF (máx. 5MB)</p>
                                                </div>
                                                <input type="file" id="edit-image-upload" accept="image/*" class="hidden" onchange="handleEditImageUpload(event)">
                                            </label>
                                            <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>A imagem será enviada junto com a promoção no Telegram</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                                    <input type="text" id="edit-product-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Preço</label>
                                        <input type="text" id="edit-price" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="R$ 0,00">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cupom</label>
                                        <input type="text" id="edit-coupon" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="CODIGO123">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <div class="relative">
                                        <input type="text" id="edit-category" 
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="Digite para buscar categoria..."
                                            autocomplete="off"
                                            oninput="filterCategorySuggestions(this.value)"
                                            onfocus="showCategorySuggestions()"
                                        >
                                        <input type="hidden" id="edit-category-id">
                                        <div id="category-suggestions" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden">
                                            <!-- Populated dynamically -->
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Sugestão da IA: <span id="edit-suggested-category" class="font-medium text-blue-600 cursor-pointer hover:underline" onclick="useSuggestedCategory()">-</span></p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Texto Processado</label>
                                    <textarea id="edit-processed-text" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <button type="button" onclick="savePromotion()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                        <i class="fas fa-save mr-2"></i>Salvar Alterações
                                    </button>
                                    <button type="button" onclick="approvePromotion()" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                        <i class="fas fa-check mr-2"></i>Aprovar e Enviar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- No Affiliate Promotions Section -->
                    <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fas fa-unlink text-orange-500 mr-2"></i>Promoções Sem Afiliado
                                    <span id="no-affiliate-badge" class="ml-2 px-2 py-1 text-xs bg-orange-100 text-orange-700 rounded-full hidden">0</span>
                                </h3>
                                <p class="text-sm text-gray-500">Promoções de lojas sem programa de afiliados configurado (Kabum, Pichau, etc.)</p>
                            </div>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <button onclick="approveAllNoAffiliate()" id="btn-approve-all-noaff" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 text-sm">
                                    <i class="fas fa-check-double mr-1"></i>Aprovar Todos
                                </button>
                                <button onclick="rejectAllNoAffiliate()" id="btn-reject-all-noaff" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50 text-sm">
                                    <i class="fas fa-times-circle mr-1"></i>Recusar Todos
                                </button>
                                <button onclick="loadNoAffiliatePromotions()" class="px-3 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Atualizar
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="no-affiliate-empty-state" class="text-center py-12 hidden">
                            <i class="fas fa-check-circle text-6xl text-green-300 mb-4"></i>
                            <h4 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma promoção sem afiliado!</h4>
                            <p class="text-gray-500">Todas as promoções recebidas têm links de afiliado.</p>
                        </div>

                        <!-- No Affiliate Promotions List -->
                        <div id="no-affiliate-list" class="space-y-4">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Postagem Tab -->
                <div id="tab-postagem" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Manual Post -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h3 class="text-xl font-bold mb-6 text-gray-800">Postagem Manual</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Texto da Oferta</label>
                                        <textarea 
                                            id="postContent" 
                                            rows="8" 
                                            placeholder="Cole aqui o texto completo da oferta com links..."
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        ></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Imagem (opcional)</label>
                                        <input type="file" id="postImage" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                                    </div>

                                    <div class="flex items-center gap-4">
                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Agendar para (opcional)</label>
                                            <input type="datetime-local" id="scheduleTime" onchange="updateButtonText()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        </div>
                                    </div>

                                    <div class="flex gap-3">
                                        <button onclick="generatePreview()" class="flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">
                                            <i class="fas fa-eye mr-2"></i>Gerar Preview
                                        </button>
                                        <button id="postButton" onclick="postNow()" class="flex-1 px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg transition-colors">
                                            <i class="fas fa-paper-plane mr-2"></i>Postar Agora
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Scheduled Posts -->
                            <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">Postagens Agendadas</h3>
                                <div id="scheduledPosts" class="space-y-3">
                                    <p class="text-gray-500 text-sm">Nenhuma postagem agendada</p>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Panel -->
                        <div>
                            <div class="bg-white rounded-xl shadow-md p-6 sticky top-6">
                                <h3 class="text-lg font-semibold mb-4">Preview</h3>
                                <!-- Telegram-style Preview -->
                                <div id="previewArea" class="border border-gray-200 rounded-lg overflow-hidden min-h-[300px] bg-gradient-to-b from-[#0088cc] to-[#006699]">
                                    <div class="p-4 text-center text-white/60 text-sm">
                                        <i class="fas fa-eye text-4xl mb-3 block opacity-50"></i>
                                        Clique em "Gerar Preview" para visualizar
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configurações Tab -->
                <div id="tab-configuracoes" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Categories -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-xl font-bold mb-6 text-gray-800">Categorias / Tópicos</h3>
                            
                            <form onsubmit="addCategory(event)" class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Categoria</label>
                                    <input type="text" id="categoryName" required placeholder="Ex: Smartphone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Thread ID</label>
                                    <input type="number" id="categoryThreadId" required placeholder="Ex: 93" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button type="submit" class="w-full px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white font-semibold rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Categoria
                                </button>
                            </form>

                            <div class="space-y-2 max-h-80 overflow-y-auto pr-2" id="categoriesList">
                                <p class="text-gray-500 text-sm">Carregando...</p>
                            </div>
                        </div>

                        <!-- Monitored Channels -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-xl font-bold mb-6 text-gray-800">Canais Monitorados</h3>
                            
                            <form onsubmit="addMonitoring(event)" class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Chat ID</label>
                                    <input type="text" id="monitorChatId" required placeholder="-1001234567890" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Canal</label>
                                    <input type="text" id="monitorName" required placeholder="Ex: Canal de Ofertas" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button type="submit" class="w-full px-6 py-3 bg-blue-900 hover:bg-blue-800 text-white font-semibold rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Canal
                                </button>
                            </form>

                            <div class="space-y-2 max-h-80 overflow-y-auto pr-2" id="monitoringList">
                                <p class="text-gray-500 text-sm">Carregando...</p>
                            </div>
                        </div>

                        <!-- Forbidden Words -->
                        <div class="bg-white rounded-xl shadow-md p-6 lg:col-span-2">
                            <h3 class="text-xl font-bold mb-6 text-gray-800">Palavras Proibidas</h3>
                            <p class="text-sm text-gray-600 mb-4">Produtos contendo estas palavras não serão postados automaticamente</p>
                            
                            <form onsubmit="addForbiddenWord(event)" class="flex gap-3 mb-6">
                                <input type="text" id="forbiddenWord" required placeholder="Ex: esgotado, indisponível" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button type="submit" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white font-semibold rounded-lg transition-colors">
                                    <i class="fas fa-ban mr-2"></i>Adicionar
                                </button>
                            </form>

                            <div id="forbiddenWordsList" class="flex flex-wrap gap-2">
                                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">Carregando...</span>
                            </div>
                        </div>

                        <!-- Excluded URLs -->
                        <div class="bg-white rounded-xl shadow-md p-6 lg:col-span-2">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">URLs Excluídas</h3>
                            <p class="text-sm text-gray-600 mb-4">Domínios e padrões de URL que serão filtrados das promoções (blogs, agregadores, etc)</p>
                            
                            <form onsubmit="addExcludedUrl(event)" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                                <input type="text" id="excludedUrlPattern" required placeholder="Ex: afneto.com ou youtube\.com" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="text" id="excludedUrlDescription" placeholder="Descrição (opcional)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button type="submit" class="px-6 py-2 bg-blue-900 hover:bg-blue-800 text-white font-semibold rounded-lg transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Adicionar
                                </button>
                            </form>
                            
                            <div class="text-xs text-blue-600 bg-blue-50 p-3 rounded mb-4">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Dica:</strong> Você pode usar expressões regulares (regex). Ex: <code>youtube\.com</code> ou <code>bit\.ly</code>. 
                                Para domínios simples, basta escrever o nome: <code>afneto.com</code>
                            </div>

                            <div id="excludedUrlsList" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 text-sm">Carregando...</p>
                            </div>
                        </div>

                        <!-- Rate Limit Configuration -->
                        <div id="rate-limit-section" class="bg-white rounded-xl shadow-md p-6 lg:col-span-2">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">
                                <i class="fas fa-tachometer-alt text-orange-500 mr-2"></i>Configuração de Rate Limit
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Limite de mensagens enviadas pelo bot para evitar bloqueios do Telegram. 
                                O Telegram permite aproximadamente 30 mensagens por segundo para bots, mas é recomendado manter um limite mais baixo.
                            </p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-envelope text-gray-500 mr-1"></i>Máximo de Mensagens
                                    </label>
                                    <input type="number" id="rate-limit-max" min="1" max="30" value="5" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <p class="text-xs text-gray-400 mt-1">Quantidade máxima de mensagens na janela</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-clock text-gray-500 mr-1"></i>Janela de Tempo (segundos)
                                    </label>
                                    <input type="number" id="rate-limit-window" min="10" max="300" value="60" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                                    <p class="text-xs text-gray-400 mt-1">Período em segundos para o limite</p>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="saveRateLimitSettings()" class="w-full px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg transition-colors">
                                        <i class="fas fa-save mr-2"></i>Salvar Rate Limit
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-orange-50 p-3 rounded-lg border border-orange-200 text-sm">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-info-circle text-orange-500"></i>
                                    <strong class="text-orange-800">Status Atual</strong>
                                </div>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <span class="text-lg font-bold text-orange-600" id="rate-config-current">0</span>
                                        <span class="text-gray-600">/<span id="rate-config-max">5</span></span>
                                        <p class="text-xs text-gray-500">Mensagens enviadas</p>
                                    </div>
                                    <div>
                                        <span class="text-lg font-bold text-orange-600" id="rate-config-remaining">5</span>
                                        <p class="text-xs text-gray-500">Disponíveis</p>
                                    </div>
                                    <div>
                                        <span class="text-lg font-bold text-orange-600" id="rate-config-reset">0s</span>
                                        <p class="text-xs text-gray-500">Próximo reset</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SaaS System Settings -->
                    <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Confgurações do Sistema</h3>
                                <p class="text-sm text-gray-500">Gerencie chaves de API, banco de dados e identidade visual</p>
                            </div>
                            <button onclick="downloadBackup()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>Exportar Backup
                            </button>
                        </div>
                        
                        <!-- Configuration Tabs / Sections -->
                        <div class="space-y-8">
                            
                            <!-- Section: Database & Redis -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-database text-blue-600"></i> Banco de Dados & Redis
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2 text-xs text-yellow-600 bg-yellow-50 p-2 rounded">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        Aviso: Alterações aqui salvam no banco, mas pode ser necessário atualizar o arquivo .env manualmente para a conexão inicial.
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">DB Host</label>
                                        <input type="text" id="setting_DB_HOST" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">DB User</label>
                                        <input type="text" id="setting_DB_USER" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">DB Password</label>
                                        <input type="password" id="setting_DB_PASS" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">DB Name</label>
                                        <input type="text" id="setting_DB_NAME" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Redis URL</label>
                                        <input type="text" id="setting_REDIS_URL" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Section: Telegram & AI -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <i class="fab fa-telegram text-blue-500"></i> Telegram
                                    </h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Bot Token</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="setting_TELEGRAM_TOKEN" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                                                <button onclick="restartBot()" class="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg" title="Reiniciar Bot">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-400 mt-1">Salve e reinicie após alterar.</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Group Chat ID</label>
                                            <input type="text" id="setting_GROUP_CHAT_ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="-100...">
                                            <p class="text-xs text-gray-400 mt-1">ID do supergrupo (negativo, ex: -1001234567890). Use /getchatid no grupo.</p>
                                        </div>
                                        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" id="setting_SEND_TO_GENERAL" class="w-4 h-4 rounded" checked>
                                                <span class="text-sm font-medium text-gray-700">
                                                    <i class="fas fa-comments text-blue-500 mr-1"></i> Enviar para o General
                                                </span>
                                            </label>
                                            <p class="text-xs text-gray-400 mt-2 ml-6">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                O General é o chat principal do grupo (não é um tópico).
                                                Desmarque para enviar apenas para os tópicos de categoria.
                                            </p>
                                        </div>
                                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" id="setting_REMOVE_IMAGE_FROM_COUPONS" class="w-4 h-4 rounded">
                                                <span class="text-sm font-medium text-gray-700">
                                                    <i class="fas fa-ticket-alt text-yellow-500 mr-1"></i> Remover imagem de Cupons
                                                </span>
                                            </label>
                                            <p class="text-xs text-gray-400 mt-2 ml-6">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Quando ativado, promoções categorizadas como "Cupom" serão enviadas sem imagem.
                                            </p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">API ID</label>
                                            <input type="text" id="setting_TELEGRAM_API_ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="123456">
                                            <p class="text-xs text-gray-400 mt-1">Obtenha em <a href="https://my.telegram.org" target="_blank" class="text-blue-500 hover:underline">my.telegram.org</a></p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">API Hash</label>
                                            <input type="password" id="setting_TELEGRAM_API_HASH" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                            <p class="text-xs text-gray-400 mt-1">Necessário para monitoramento por conta pessoal</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-robot text-purple-600"></i> Inteligência Artificial
                                    </h4>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                                        <input type="password" id="setting_GEMINI_API_KEY" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                </div>
                            </div>

                            <!-- Section: User Account Monitor -->
                            <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-user-secret text-purple-600"></i> Monitoramento por Conta Pessoal
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full ml-2">MTProto</span>
                                </h4>
                                
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded-r-lg">
                                    <p class="text-sm text-yellow-800">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Use este recurso para monitorar grupos que não permitem bots. 
                                        As mensagens serão captadas pela sua conta e enviadas pelo bot.
                                    </p>
                                </div>

                                <div id="userMonitorSection">
                                    <!-- Status -->
                                    <div class="flex items-center gap-4 mb-4 p-3 bg-white rounded-lg border">
                                        <div class="flex items-center gap-2">
                                            <div id="userMonitorStatusDot" class="w-3 h-3 rounded-full bg-gray-400"></div>
                                            <span id="userMonitorStatusText" class="text-sm text-gray-600">Verificando...</span>
                                        </div>
                                        <div class="flex-1"></div>
                                        <button onclick="checkUserMonitorStatus()" class="text-sm text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-sync-alt mr-1"></i>Atualizar
                                        </button>
                                    </div>

                                    <!-- Login Form (shown when not connected) -->
                                    <div id="userMonitorLoginForm" class="hidden space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Número de Telefone</label>
                                            <div class="flex gap-2">
                                                <input type="tel" id="userMonitorPhone" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="+55 11 99999-9999">
                                                <button onclick="startUserMonitorLogin()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
                                                    <i class="fas fa-paper-plane mr-1"></i>Enviar Código
                                                </button>
                                            </div>
                                        </div>

                                        <div id="userMonitorCodeSection" class="hidden">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Código de Verificação</label>
                                            <div class="flex gap-2">
                                                <input type="text" id="userMonitorCode" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="12345">
                                                <button onclick="verifyUserMonitorCode()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                                    <i class="fas fa-check mr-1"></i>Verificar
                                                </button>
                                            </div>
                                        </div>

                                        <div id="userMonitor2FASection" class="hidden">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Senha 2FA</label>
                                            <div class="flex gap-2">
                                                <input type="password" id="userMonitor2FA" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Sua senha de dois fatores">
                                                <button onclick="verifyUserMonitorCode()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                                    <i class="fas fa-check mr-1"></i>Verificar
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Connected Panel (shown when connected) -->
                                    <div id="userMonitorConnectedPanel" class="hidden space-y-4">
                                        <div class="flex items-center gap-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                            <div>
                                                <p class="font-medium text-green-800">Conta Conectada</p>
                                                <p id="userMonitorUserInfo" class="text-sm text-green-600"></p>
                                            </div>
                                        </div>

                                        <div class="flex gap-3">
                                            <button onclick="startUserMonitoring()" id="btnStartMonitoring" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                                <i class="fas fa-play mr-2"></i>Iniciar Monitoramento
                                            </button>
                                            <button onclick="stopUserMonitoring()" id="btnStopMonitoring" class="hidden flex-1 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg">
                                                <i class="fas fa-pause mr-2"></i>Pausar Monitoramento
                                            </button>
                                            <button onclick="logoutUserMonitor()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                                                <i class="fas fa-sign-out-alt mr-2"></i>Desconectar
                                            </button>
                                        </div>

                                        <div class="text-sm text-gray-500">
                                            <p><i class="fas fa-info-circle mr-1"></i>O monitoramento usa os mesmos grupos configurados na seção "Grupos Monitorados".</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section: Affiliates -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-shopping-cart text-green-600"></i> APIs de Afiliados
                                </h4>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <!-- Shopee -->
                                    <div class="space-y-3 p-3 bg-white rounded border border-gray-100">
                                        <h5 class="font-bold text-orange-500 text-sm border-b pb-1 mb-2">Shopee</h5>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">App ID</label>
                                            <input type="text" id="setting_SHOPEE_APP_ID" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">App Secret</label>
                                            <input type="password" id="setting_SHOPEE_APP_SECRET" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Affiliate ID</label>
                                            <input type="text" id="setting_SHOPEE_AFFILIATE_ID" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">API Key</label>
                                            <input type="password" id="setting_SHOPEE_API_KEY" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                    </div>

                                    <!-- Mercado Livre -->
                                    <div class="space-y-3 p-3 bg-white rounded border border-gray-100">
                                        <h5 class="font-bold text-yellow-500 text-sm border-b pb-1 mb-2">Mercado Livre</h5>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Tag de Afiliado</label>
                                            <input type="text" id="setting_ML_AFFILIATE_TAG" placeholder="bryanandradetk" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Cookies (para Short Links)</label>
                                            <textarea id="setting_ML_COOKIES" rows="3" placeholder="_d2id=xxx; _csrf=xxx; ssid=xxx; ..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm font-mono text-xs"></textarea>
                                            <p class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> Copie os cookies do navegador logado no ML para gerar links curtos (mercadolivre.com/sec/xxx)</p>
                                        </div>
                                    </div>

                                    <!-- AliExpress -->
                                    <div class="space-y-3 p-3 bg-white rounded border border-gray-100">
                                        <h5 class="font-bold text-red-500 text-sm border-b pb-1 mb-2">AliExpress</h5>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">App Key</label>
                                            <input type="text" id="setting_ALIEXPRESS_APP_KEY" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">App Secret</label>
                                            <input type="password" id="setting_ALIEXPRESS_APP_SECRET" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Tracking ID</label>
                                            <input type="text" id="setting_ALIEXPRESS_TRACKING_ID" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Cookies do Portal (para Short Links)</label>
                                            <textarea id="setting_ALIEXPRESS_COOKIES" rows="3" placeholder="xman_us_f=xxx; xman_t=xxx; aep_usuc_f=xxx; ..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm font-mono text-xs"></textarea>
                                            <p class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> Copie os cookies do navegador logado no Portal AliExpress para gerar links curtos (s.click.aliexpress.com)</p>
                                        </div>
                                    </div>

                                    <!-- Amazon -->
                                    <div class="space-y-3 p-3 bg-white rounded border border-gray-100">
                                        <h5 class="font-bold text-yellow-600 text-sm border-b pb-1 mb-2">Amazon</h5>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Tracking ID (Tag)</label>
                                            <input type="text" id="setting_AMAZON_TRACKING_ID" placeholder="ofertasdoesqu-20" class="w-full px-3 py-1 border border-gray-300 rounded text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-gray-500">Cookies do SiteStripe (para Short Links)</label>
                                            <textarea id="setting_AMAZON_COOKIES" rows="3" placeholder="session-id=xxx; ubid-acbbr=xxx; at-acbbr=xxx; ..." class="w-full px-3 py-1 border border-gray-300 rounded text-sm font-mono text-xs"></textarea>
                                            <p class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> Copie os cookies do navegador logado no Amazon Associates para gerar links curtos (amzn.to)</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Affiliate Platform Toggles -->
                                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h5 class="font-semibold text-blue-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-toggle-on text-blue-600"></i> Ativar/Desativar Plataformas
                                    </h5>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-orange-400 transition-colors">
                                            <input type="checkbox" id="setting_AFFILIATE_SHOPEE_ENABLED" class="w-5 h-5 text-orange-500 rounded">
                                            <span class="font-medium text-gray-700">Shopee</span>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-yellow-400 transition-colors">
                                            <input type="checkbox" id="setting_AFFILIATE_ML_ENABLED" class="w-5 h-5 text-yellow-500 rounded">
                                            <span class="font-medium text-gray-700">Mercado Livre</span>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-red-400 transition-colors">
                                            <input type="checkbox" id="setting_AFFILIATE_ALIEXPRESS_ENABLED" class="w-5 h-5 text-red-500 rounded">
                                            <span class="font-medium text-gray-700">AliExpress</span>
                                        </label>
                                        <label class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 cursor-pointer hover:border-yellow-500 transition-colors">
                                            <input type="checkbox" id="setting_AFFILIATE_AMAZON_ENABLED" class="w-5 h-5 text-yellow-600 rounded">
                                            <span class="font-medium text-gray-700">Amazon</span>
                                        </label>
                                    </div>
                                    <p class="text-xs text-blue-600 mt-3"><i class="fas fa-info-circle"></i> Desativando uma plataforma, os links dessa loja não serão convertidos para afiliados.</p>
                                </div>

                                <!-- Auto Cookie Capture -->
                                <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                                    <h5 class="font-semibold text-green-800 mb-4 flex items-center gap-2">
                                        <i class="fas fa-cookie-bite text-green-600"></i> Captura Automática de Cookies
                                    </h5>
                                    <p class="text-xs text-green-700 mb-4">
                                        <i class="fas fa-info-circle"></i> 
                                        Clique em "Capturar" para abrir o navegador, faça login na plataforma, e depois clique em "Confirmar Captura".
                                        Os cookies serão salvos automaticamente para gerar links curtos (amzn.to, mercadolivre.com/sec/xxx).
                                    </p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <!-- Mercado Livre Cookies -->
                                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                                            <div class="flex items-center justify-between mb-3">
                                                <h6 class="font-bold text-yellow-600 flex items-center gap-2">
                                                    <i class="fas fa-handshake"></i> Mercado Livre
                                                </h6>
                                                <span id="mlCookieStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">
                                                    Verificando...
                                                </span>
                                            </div>
                                            <p id="mlCookieDate" class="text-xs text-gray-500 mb-3"></p>
                                            <div class="flex gap-2">
                                                <button onclick="openBrowser('ml')" id="btnMlOpen" class="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-external-link-alt mr-1"></i> Abrir
                                                </button>
                                                <button onclick="captureCookies('ml')" id="btnMlCapture" class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-check mr-1"></i> Capturar
                                                </button>
                                                <button onclick="clearCookies('mercadolivre')" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Amazon Cookies -->
                                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                                            <div class="flex items-center justify-between mb-3">
                                                <h6 class="font-bold text-yellow-600 flex items-center gap-2">
                                                    <i class="fab fa-amazon"></i> Amazon
                                                </h6>
                                                <span id="amazonCookieStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">
                                                    Verificando...
                                                </span>
                                            </div>
                                            <p id="amazonCookieDate" class="text-xs text-gray-500 mb-3"></p>
                                            <div class="flex gap-2">
                                                <button onclick="openBrowser('amazon')" id="btnAmazonOpen" class="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-external-link-alt mr-1"></i> Abrir
                                                </button>
                                                <button onclick="captureCookies('amazon')" id="btnAmazonCapture" class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-check mr-1"></i> Capturar
                                                </button>
                                                <button onclick="clearCookies('amazon')" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- AliExpress Cookies -->
                                        <div class="p-4 bg-white rounded-lg border border-gray-200">
                                            <div class="flex items-center justify-between mb-3">
                                                <h6 class="font-bold text-red-500 flex items-center gap-2">
                                                    <i class="fas fa-shopping-bag"></i> AliExpress
                                                </h6>
                                                <span id="aliexpressCookieStatus" class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">
                                                    Verificando...
                                                </span>
                                            </div>
                                            <p id="aliexpressCookieDate" class="text-xs text-gray-500 mb-3"></p>
                                            <div class="flex gap-2">
                                                <button onclick="openBrowser('aliexpress')" id="btnAliexpressOpen" class="flex-1 px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-external-link-alt mr-1"></i> Abrir
                                                </button>
                                                <button onclick="captureCookies('aliexpress')" id="btnAliexpressCapture" class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-check mr-1"></i> Capturar
                                                </button>
                                                <button onclick="clearCookies('aliexpress')" class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 text-sm font-semibold rounded-lg transition-colors">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <p class="text-xs text-gray-500 mt-3 text-center">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Clique em "Abrir" → Faça login no site → Clique em "Capturar"
                                    </p>
                                </div>
                            </div>

                            <!-- Visual Identity -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                    <i class="fas fa-paint-brush text-pink-500"></i> Identidade Visual
                                </h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Logo do Painel</label>
                                        <div class="flex gap-2 items-center">
                                            <img src="/img/logo.png" id="preview-logo" class="h-10 w-10 object-contain border rounded p-1 bg-white">
                                            <input type="file" id="logoInput" accept="image/png, image/jpeg" onchange="uploadLogo()" class="flex-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cores do Tema</label>
                                        <div class="flex gap-4">
                                            <div class="flex flex-col items-center">
                                                <input type="color" id="setting_THEME_COLOR_PRIMARY" class="h-10 w-16 border rounded cursor-pointer">
                                                <span class="text-xs text-gray-500 mt-1">Primária</span>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <input type="color" id="setting_THEME_COLOR_SECONDARY" class="h-10 w-16 border rounded cursor-pointer">
                                                <span class="text-xs text-gray-500 mt-1">Secundária</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fonte (Google Fonts URL)</label>
                                        <input type="text" id="setting_THEME_FONT_URL" placeholder="https://fonts.googleapis.com/css2?family=Roboto..." class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                        <p class="text-xs text-gray-400 mt-1">Cole a URL completa do Google Fonts</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                        <div class="mt-8 pt-6 border-t flex justify-end">
                            <button onclick="saveSettings()" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors shadow-lg flex items-center">
                                <i class="fas fa-save mr-2"></i> Salvar Configurações do Sistema
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Histórico de Processamento</h3>
                            <button onclick="refreshLogs()" class="px-4 py-2 bg-blue-900 hover:bg-blue-800 text-white rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Atualizar
                            </button>
                        </div>

                        <div class="space-y-3" id="logsList">
                            <p class="text-gray-500 text-sm">Carregando logs...</p>
                        </div>
                    </div>
                </div>

                <!-- Scripts Tab -->
                <div id="tab-scripts" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-code text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Scripts Úteis</h3>
                                <p class="text-sm text-gray-500">Scripts auxiliares para configuração</p>
                            </div>
                        </div>

                        <!-- Script para pegar ID do Grupo -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 border border-purple-100">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fab fa-telegram text-white text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Pegar ID do Grupo (Telegram Web)</h4>
                                    <p class="text-sm text-gray-500">Script para obter o ID do grupo via console do navegador</p>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-exclamation-triangle text-yellow-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-yellow-800">Como usar:</h5>
                                        <ol class="text-sm text-yellow-700 mt-2 space-y-1 list-decimal list-inside">
                                            <li>Abra o <strong>Telegram Web</strong> no navegador</li>
                                            <li>Entre no grupo que deseja obter o ID</li>
                                            <li>Pressione <kbd class="bg-gray-200 px-2 py-1 rounded text-xs">F12</kbd> para abrir o DevTools</li>
                                            <li>Vá na aba <strong>Console</strong></li>
                                            <li>Cole o script abaixo e pressione <kbd class="bg-gray-200 px-2 py-1 rounded text-xs">Enter</kbd></li>
                                            <li>O console retornará algo como: <code class="bg-gray-200 px-2 py-1 rounded text-xs">ID do grupo atual: -3747927678</code></li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-red-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-red-800">⚠️ Importante - Formatação do ID:</h5>
                                        <p class="text-sm text-red-700 mt-1">
                                            O ID retornado precisa ser formatado! Retire o <strong>-</strong> antes dos números.
                                        </p>
                                        <div class="mt-2 bg-white rounded-lg p-3 text-sm">
                                            <p class="text-gray-600">Exemplo:</p>
                                            <p class="font-mono">ID retornado: <span class="text-red-600">-3747927678</span></p>
                                            <p class="font-mono">ID formatado: <span class="text-green-600">3747927678</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="relative">
                                <pre id="scriptGroupId" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>// Limpa o console para melhor visualização
console.clear();

// Pega o container do chat atualmente aberto
const chat = document.querySelector('.chat, .conversation, .Chat');

let peerId = null;

// 1️⃣ Tenta pegar pelo header do chat aberto
const headerPeer = chat?.querySelector('[data-peer-id]');

if (headerPeer) {
  peerId = headerPeer.getAttribute('data-peer-id');
}

// 2️⃣ Fallback: pega pelo atributo href do chat ativo
if (!peerId) {
  const activeChat = document.querySelector('.chatlist-chat.is-selected, .chatlist-chat.active');
  peerId = activeChat?.getAttribute('data-peer-id') ||
           activeChat?.getAttribute('href')?.replace('#', '');
}

if (peerId) {
  console.log('%c🆔 ID do grupo atual:', 'font-size: 14px; font-weight: bold; color: #22c55e;');
  console.log('%c' + peerId, 'font-size: 18px; font-weight: bold; color: #3b82f6; background: #1e3a8a; padding: 8px 16px; border-radius: 8px;');
  console.log('%c⚠️ Lembre-se: Adicione 100 após o sinal de menos!', 'font-size: 12px; color: #f59e0b;');
  console.log('%cExemplo: ' + peerId + ' → -100' + peerId.replace('-', ''), 'font-size: 12px; color: #9ca3af;');
} else {
  console.log('%c❌ Não foi possível detectar o grupo atual', 'font-size: 14px; color: #ef4444;');
}</code></pre>
                                <button onclick="copyScript('scriptGroupId')" class="absolute top-2 right-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                    <i class="fas fa-copy mr-1"></i>Copiar
                                </button>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="border-t border-gray-200 my-8"></div>

                        <!-- Tutorial para pegar Cookies da Amazon -->
                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 border border-yellow-100 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center">
                                    <i class="fab fa-amazon text-white text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Pegar Cookies da Amazon</h4>
                                    <p class="text-sm text-gray-500">Para gerar links curtos (amzn.to)</p>
                                </div>
                            </div>

                            <!-- Método Automático (Recomendado) -->
                            <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-magic text-green-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-green-800">✨ Método Automático (Recomendado)</h5>
                                        <p class="text-sm text-green-700 mt-1">
                                            Use a <strong>Captura Automática de Cookies</strong> nas configurações de Afiliados.
                                            O sistema abrirá um navegador, você faz login, e os cookies são capturados automaticamente!
                                        </p>
                                        <button onclick="showTab('configuracoes')" class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors">
                                            <i class="fas fa-arrow-right mr-2"></i>Ir para Configurações
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Método Manual (Alternativa) -->
                            <details class="bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
                                <summary class="p-4 cursor-pointer font-semibold text-yellow-800 hover:bg-yellow-100 transition-colors">
                                    <i class="fas fa-hand-paper mr-2"></i>Método Manual (Alternativa)
                                </summary>
                                <div class="p-4 pt-0">
                                    <ol class="text-sm text-yellow-700 space-y-2 list-decimal list-inside">
                                        <li>Acesse <a href="https://associados.amazon.com.br" target="_blank" class="underline font-semibold">associados.amazon.com.br</a> e faça login</li>
                                        <li>Vá para qualquer página de <strong>produto na Amazon</strong></li>
                                        <li>Pressione <kbd class="bg-gray-200 px-2 py-1 rounded text-xs">F12</kbd> para abrir o DevTools</li>
                                        <li>Vá na aba <strong class="text-yellow-900">Network</strong> (Rede)</li>
                                        <li>Na barra do SiteStripe (topo), clique em <strong>"Obter Link"</strong> → <strong>"Link Curto"</strong></li>
                                        <li>No DevTools, procure a requisição <code class="bg-white px-2 py-1 rounded font-mono text-xs">getShortUrl</code></li>
                                        <li>Clique na requisição e vá em <strong>Headers</strong></li>
                                        <li>Procure por <strong>"Cookie:"</strong> em "Request Headers"</li>
                                        <li>Copie todo o valor e cole nas configurações</li>
                                    </ol>
                                    
                                    <p class="text-sm text-yellow-700 mt-4 mb-2"><strong>Ou use o script abaixo no Console:</strong></p>
                                    <div class="relative">
                                        <pre id="scriptAmazonCookies" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>// Limpa o console para melhor visualização
console.clear();

// Pega os cookies da Amazon
const cookies = document.cookie;

console.log('%c🍪 Cookies da Amazon:', 'font-size: 14px; font-weight: bold; color: #f59e0b;');
console.log('%c' + cookies, 'font-size: 11px; color: #22c55e; background: #1a1a1a; padding: 8px; border-radius: 4px; word-break: break-all;');
console.log('%c📋 Copie o texto acima e cole nas configurações', 'font-size: 12px; color: #9ca3af;');</code></pre>
                                        <button onclick="copyScript('scriptAmazonCookies')" class="absolute top-2 right-2 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                            <i class="fas fa-copy mr-1"></i>Copiar
                                        </button>
                                    </div>
                                </div>
                            </details>

                            <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mt-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-orange-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-orange-800">⚠️ Importante:</h5>
                                        <p class="text-sm text-orange-700 mt-1">
                                            Os cookies da Amazon expiram periodicamente (1-2 semanas). Quando os links pararem de encurtar, repita o processo.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tutorial para pegar Cookies do Mercado Livre -->
                        <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl p-6 border border-yellow-200 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-yellow-400 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-handshake text-white text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Pegar Cookies do Mercado Livre</h4>
                                    <p class="text-sm text-gray-500">Para gerar links curtos (mercadolivre.com/sec/xxx)</p>
                                </div>
                            </div>

                            <!-- Método Automático (Recomendado) -->
                            <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-magic text-green-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-green-800">✨ Método Automático (Recomendado)</h5>
                                        <p class="text-sm text-green-700 mt-1">
                                            Use a <strong>Captura Automática de Cookies</strong> nas configurações de Afiliados.
                                            O sistema abrirá um navegador, você faz login, e os cookies são capturados automaticamente!
                                        </p>
                                        <button onclick="showTab('configuracoes')" class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors">
                                            <i class="fas fa-arrow-right mr-2"></i>Ir para Configurações
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Método Manual (Alternativa) -->
                            <details class="bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg">
                                <summary class="p-4 cursor-pointer font-semibold text-yellow-800 hover:bg-yellow-100 transition-colors">
                                    <i class="fas fa-hand-paper mr-2"></i>Método Manual (Alternativa)
                                </summary>
                                <div class="p-4 pt-0">
                                    <ol class="text-sm text-yellow-700 space-y-2 list-decimal list-inside">
                                        <li>Acesse <a href="https://www.mercadolivre.com.br" target="_blank" class="underline font-semibold">mercadolivre.com.br</a> e faça login na sua conta de afiliado</li>
                                        <li>Vá para qualquer página de <strong>produto no Mercado Livre</strong></li>
                                        <li>Pressione <kbd class="bg-gray-200 px-2 py-1 rounded text-xs">F12</kbd> para abrir o DevTools</li>
                                        <li>Vá na aba <strong class="text-yellow-900">Network</strong> (Rede)</li>
                                        <li>Na página do produto, clique no botão <strong>"Compartilhar"</strong></li>
                                        <li>No DevTools, procure a requisição <code class="bg-white px-2 py-1 rounded font-mono text-xs">links</code></li>
                                        <li>Clique na requisição e vá em <strong>Headers</strong></li>
                                        <li>Procure por <strong>"Cookie:"</strong> em "Request Headers"</li>
                                        <li>Copie todo o valor e cole nas configurações</li>
                                    </ol>
                                    
                                    <p class="text-sm text-yellow-700 mt-4 mb-2"><strong>Ou use o script abaixo no Console (na página do ML):</strong></p>
                                    <div class="relative">
                                        <pre id="scriptMLCookies" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>// Limpa o console para melhor visualização
console.clear();

// Pega os cookies do Mercado Livre
const cookies = document.cookie;

console.log('%c🍪 Cookies do Mercado Livre:', 'font-size: 14px; font-weight: bold; color: #ffe600;');
console.log('%c' + cookies, 'font-size: 11px; color: #22c55e; background: #1a1a1a; padding: 8px; border-radius: 4px; word-break: break-all;');
console.log('%c📋 Copie o texto acima e cole nas configurações', 'font-size: 12px; color: #9ca3af;');</code></pre>
                                        <button onclick="copyScript('scriptMLCookies')" class="absolute top-2 right-2 bg-yellow-400 hover:bg-yellow-500 text-gray-800 px-3 py-2 rounded-lg text-sm transition-colors">
                                            <i class="fas fa-copy mr-1"></i>Copiar
                                        </button>
                                    </div>
                                </div>
                            </details>

                            <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mt-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-amber-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-amber-800">⚠️ Importante:</h5>
                                        <p class="text-sm text-amber-700 mt-1">
                                            O token CSRF (<code class="bg-white px-1 rounded">_csrf</code>) está incluído nos cookies e é extraído automaticamente. Se os links pararem de funcionar, recapture os cookies.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tutorial para pegar Cookies do AliExpress -->
                        <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-xl p-6 border border-red-200">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-shopping-bag text-white text-lg"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Pegar Cookies do AliExpress</h4>
                                    <p class="text-sm text-gray-500">Para gerar links curtos (s.click.aliexpress.com)</p>
                                </div>
                            </div>

                            <!-- Método Automático (Recomendado) -->
                            <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-magic text-green-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-green-800">✨ Método Automático (Recomendado)</h5>
                                        <p class="text-sm text-green-700 mt-1">
                                            Use a <strong>Captura Automática de Cookies</strong> nas configurações de Afiliados.
                                            O sistema abrirá o portal de afiliados, você faz login, e os cookies são capturados automaticamente!
                                        </p>
                                        <button onclick="showTab('configuracoes')" class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors">
                                            <i class="fas fa-arrow-right mr-2"></i>Ir para Configurações
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Método Manual (Alternativa) -->
                            <details class="bg-red-50 border-l-4 border-red-400 rounded-r-lg">
                                <summary class="p-4 cursor-pointer font-semibold text-red-800 hover:bg-red-100 transition-colors">
                                    <i class="fas fa-hand-paper mr-2"></i>Método Manual (Alternativa)
                                </summary>
                                <div class="p-4 pt-0">
                                    <ol class="text-sm text-red-700 space-y-2 list-decimal list-inside">
                                        <li>Acesse <a href="https://portals.aliexpress.com" target="_blank" class="underline font-semibold">portals.aliexpress.com</a> e faça login</li>
                                        <li>Vá para <strong>Ferramentas</strong> → <strong>Gerador de Links</strong></li>
                                        <li>Pressione <kbd class="bg-gray-200 px-2 py-1 rounded text-xs">F12</kbd> para abrir o DevTools</li>
                                        <li>Vá na aba <strong class="text-red-900">Application</strong> (ou Storage)</li>
                                        <li>No menu lateral, clique em <strong>Cookies</strong> → <strong>portals.aliexpress.com</strong></li>
                                        <li>Copie todos os cookies importantes (ou use o script abaixo)</li>
                                    </ol>
                                    
                                    <p class="text-sm text-red-700 mt-4 mb-2"><strong>Use o script abaixo no Console (na página do Portal AliExpress):</strong></p>
                                    <div class="relative">
                                        <pre id="scriptAliExpressCookies" class="bg-gray-900 text-green-400 p-4 rounded-lg text-sm overflow-x-auto font-mono"><code>// Limpa o console para melhor visualização
console.clear();

// Pega os cookies do AliExpress
const cookies = document.cookie;

console.log('%c🍪 Cookies do AliExpress Portal:', 'font-size: 14px; font-weight: bold; color: #ff4747;');
console.log('%c' + cookies, 'font-size: 11px; color: #22c55e; background: #1a1a1a; padding: 8px; border-radius: 4px; word-break: break-all;');
console.log('%c📋 Copie o texto acima e cole nas configurações', 'font-size: 12px; color: #9ca3af;');
console.log('%c⚠️ Execute este script em portals.aliexpress.com', 'font-size: 12px; color: #f59e0b;');</code></pre>
                                        <button onclick="copyScript('scriptAliExpressCookies')" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                            <i class="fas fa-copy mr-1"></i>Copiar
                                        </button>
                                    </div>
                                </div>
                            </details>

                            <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mt-4 rounded-r-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-info-circle text-orange-500 mt-1"></i>
                                    <div>
                                        <h5 class="font-semibold text-orange-800">⚠️ Importante:</h5>
                                        <p class="text-sm text-orange-700 mt-1">
                                            O AliExpress usa o <strong>Portal de Afiliados</strong> para gerar links. Certifique-se de estar logado em <code class="bg-white px-1 rounded">portals.aliexpress.com</code> e não no site normal.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Toast Notification System
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-700');
            });
            event.target.closest('.nav-item').classList.add('bg-blue-700');
            
            const titles = {
                'dashboard': 'Dashboard',
                'promocoes': 'Promoções Pendentes',
                'postagem': 'Postagem',
                'configuracoes': 'Configurações',
                'logs': 'Logs',
                'scripts': 'Scripts'
            };
            document.getElementById('pageTitle').textContent = titles[tabName];
            
            // Load pending promotions when tab is opened
            if (tabName === 'promocoes') {
                loadPendingPromotions();
                loadNoAffiliatePromotions();
            }
        }

        // Copy Script to Clipboard
        function copyScript(elementId) {
            const scriptElement = document.getElementById(elementId);
            const scriptText = scriptElement.textContent;
            
            navigator.clipboard.writeText(scriptText).then(() => {
                showToast('Script copiado para a área de transferência!', 'success');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                showToast('Erro ao copiar o script', 'error');
            });
        }

        // ============================================
        // User Monitor Functions (MTProto)
        // ============================================
        
        async function checkUserMonitorStatus() {
            try {
                const response = await fetch('/api/user-monitor/status');
                const status = await response.json();
                
                const dot = document.getElementById('userMonitorStatusDot');
                const text = document.getElementById('userMonitorStatusText');
                const loginForm = document.getElementById('userMonitorLoginForm');
                const connectedPanel = document.getElementById('userMonitorConnectedPanel');
                const btnStart = document.getElementById('btnStartMonitoring');
                const btnStop = document.getElementById('btnStopMonitoring');
                
                if (status.connected) {
                    dot.className = 'w-3 h-3 rounded-full bg-green-500';
                    text.textContent = status.monitoring ? 'Conectado e Monitorando' : 'Conectado';
                    loginForm.classList.add('hidden');
                    connectedPanel.classList.remove('hidden');
                    
                    if (status.monitoring) {
                        btnStart.classList.add('hidden');
                        btnStop.classList.remove('hidden');
                    } else {
                        btnStart.classList.remove('hidden');
                        btnStop.classList.add('hidden');
                    }
                } else if (status.hasSession) {
                    dot.className = 'w-3 h-3 rounded-full bg-yellow-500';
                    text.textContent = 'Sessão salva - Reconectando...';
                    loginForm.classList.add('hidden');
                    connectedPanel.classList.add('hidden');
                    
                    // Try to reconnect
                    await reconnectUserMonitor();
                } else {
                    dot.className = 'w-3 h-3 rounded-full bg-gray-400';
                    text.textContent = 'Desconectado';
                    loginForm.classList.remove('hidden');
                    connectedPanel.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error checking user monitor status:', err);
                document.getElementById('userMonitorStatusText').textContent = 'Erro ao verificar status';
            }
        }
        
        async function reconnectUserMonitor() {
            try {
                const response = await fetch('/api/user-monitor/connect', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    if (result.user) {
                        document.getElementById('userMonitorUserInfo').textContent = 
                            `${result.user.firstName} (@${result.user.username || result.user.phone})`;
                    }
                }
                
                await checkUserMonitorStatus();
            } catch (err) {
                console.error('Error reconnecting:', err);
            }
        }
        
        async function startUserMonitorLogin() {
            const phone = document.getElementById('userMonitorPhone').value.trim();
            if (!phone) {
                showToast('Digite o número de telefone', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user-monitor/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    document.getElementById('userMonitorCodeSection').classList.remove('hidden');
                } else {
                    showToast(result.error || 'Erro ao enviar código', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }
        
        async function verifyUserMonitorCode() {
            const code = document.getElementById('userMonitorCode').value.trim();
            const password = document.getElementById('userMonitor2FA')?.value?.trim();
            
            if (!code) {
                showToast('Digite o código de verificação', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user-monitor/login/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkUserMonitorStatus();
                } else if (result.requires2FA) {
                    showToast(result.message, 'info');
                    document.getElementById('userMonitor2FASection').classList.remove('hidden');
                } else {
                    showToast(result.error || 'Erro na verificação', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }
        
        async function startUserMonitoring() {
            try {
                const response = await fetch('/api/user-monitor/start', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkUserMonitorStatus();
                } else {
                    showToast(result.error || 'Erro ao iniciar', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }
        
        async function stopUserMonitoring() {
            try {
                const response = await fetch('/api/user-monitor/stop', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkUserMonitorStatus();
                } else {
                    showToast(result.error || 'Erro ao pausar', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }
        
        async function logoutUserMonitor() {
            if (!confirm('Tem certeza que deseja desconectar a conta?')) return;
            
            try {
                const response = await fetch('/api/user-monitor/logout', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkUserMonitorStatus();
                } else {
                    showToast(result.error || 'Erro ao desconectar', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }

        // ============================================
        // Cookie Capture Functions
        // ============================================
        
        async function checkCookieStatus() {
            try {
                const response = await fetch('/api/cookies/status');
                const status = await response.json();
                
                // Mercado Livre
                const mlStatus = document.getElementById('mlCookieStatus');
                const mlDate = document.getElementById('mlCookieDate');
                if (status.mercadolivre.hasCookies) {
                    mlStatus.textContent = 'Configurado';
                    mlStatus.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
                    mlDate.textContent = status.mercadolivre.lastUpdated 
                        ? `Atualizado: ${new Date(status.mercadolivre.lastUpdated).toLocaleString('pt-BR')}`
                        : '';
                } else {
                    mlStatus.textContent = 'Não configurado';
                    mlStatus.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-600';
                    mlDate.textContent = '';
                }
                
                // Amazon
                const amazonStatus = document.getElementById('amazonCookieStatus');
                const amazonDate = document.getElementById('amazonCookieDate');
                if (status.amazon.hasCookies) {
                    amazonStatus.textContent = 'Configurado';
                    amazonStatus.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
                    amazonDate.textContent = status.amazon.lastUpdated 
                        ? `Atualizado: ${new Date(status.amazon.lastUpdated).toLocaleString('pt-BR')}`
                        : '';
                } else {
                    amazonStatus.textContent = 'Não configurado';
                    amazonStatus.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-600';
                    amazonDate.textContent = '';
                }
                
                // AliExpress
                const aliexpressStatus = document.getElementById('aliexpressCookieStatus');
                const aliexpressDate = document.getElementById('aliexpressCookieDate');
                if (status.aliexpress && status.aliexpress.hasCookies) {
                    aliexpressStatus.textContent = 'Configurado';
                    aliexpressStatus.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-700';
                    aliexpressDate.textContent = status.aliexpress.lastUpdated 
                        ? `Atualizado: ${new Date(status.aliexpress.lastUpdated).toLocaleString('pt-BR')}`
                        : '';
                } else {
                    aliexpressStatus.textContent = 'Não configurado';
                    aliexpressStatus.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-600';
                    aliexpressDate.textContent = '';
                }
            } catch (err) {
                console.error('Erro ao verificar cookies:', err);
            }
        }
        
        // Open browser for login
        async function openBrowser(platform) {
            let btn;
            if (platform === 'ml') btn = document.getElementById('btnMlOpen');
            else if (platform === 'amazon') btn = document.getElementById('btnAmazonOpen');
            else if (platform === 'aliexpress') btn = document.getElementById('btnAliexpressOpen');
            
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Abrindo...';
                
                let endpoint;
                if (platform === 'ml') endpoint = '/api/cookies/ml/start';
                else if (platform === 'amazon') endpoint = '/api/cookies/amazon/start';
                else if (platform === 'aliexpress') endpoint = '/api/cookies/aliexpress/start';
                
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'info');
                } else {
                    showToast(result.error || 'Erro ao abrir navegador', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Capture cookies after login
        async function captureCookies(platform) {
            let btn;
            if (platform === 'ml') btn = document.getElementById('btnMlCapture');
            else if (platform === 'amazon') btn = document.getElementById('btnAmazonCapture');
            else if (platform === 'aliexpress') btn = document.getElementById('btnAliexpressCapture');
            
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Capturando...';
                
                let endpoint;
                if (platform === 'ml') endpoint = '/api/cookies/ml/capture';
                else if (platform === 'amazon') endpoint = '/api/cookies/amazon/capture';
                else if (platform === 'aliexpress') endpoint = '/api/cookies/aliexpress/capture';
                
                const response = await fetch(endpoint, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkCookieStatus();
                } else {
                    showToast(result.error || 'Erro ao capturar cookies', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function clearCookies(platform) {
            if (!confirm(`Tem certeza que deseja remover os cookies do ${platform}?`)) return;
            
            try {
                const response = await fetch('/api/cookies/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platform })
                });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    await checkCookieStatus();
                } else {
                    showToast(result.error || 'Erro ao remover cookies', 'error');
                }
            } catch (err) {
                showToast('Erro: ' + err.message, 'error');
            }
        }

        // API Status Check
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                ['shopee', 'ml', 'ali', 'amazon', 'ai'].forEach(api => {
                    const dot = document.getElementById(`status-${api}`);
                    const latencySpan = document.getElementById(`latency-${api}`);
                    
                    if (data[api] && data[api].online) {
                        dot.classList.add('online');
                        dot.classList.remove('offline');
                        
                        // Show latency if available
                        if (data[api].latency) {
                            latencySpan.textContent = `(${data[api].latency}ms)`;
                        }
                    } else {
                        dot.classList.add('offline');
                        dot.classList.remove('online');
                        
                        // Show error message if available
                        if (data[api] && data[api].error) {
                            latencySpan.textContent = `(${data[api].error})`;
                        }
                    }
                });
            } catch (err) {
                console.error('Failed to check API status:', err);
            }
        }

        // Load Metrics
        async function loadMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                document.getElementById('metric-today').textContent = data.offersToday || 0;
                document.getElementById('metric-channels').textContent = data.activeChannels || 0;
                document.getElementById('metric-errors').textContent = data.errors || 0;
            } catch (err) {
                console.error('Failed to load metrics:', err);
            }
        }

        // Load Recent Activity
        async function loadRecentActivity() {
            try {
                const response = await fetch('/api/recent-activity');
                const activities = await response.json();
                
                const html = activities.map(act => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 rounded-full ${act.success ? 'bg-green-500' : 'bg-red-500'}"></div>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">${act.product_name || 'Produto'}</p>
                                <p class="text-xs text-gray-500">${act.category || 'Sem categoria'} ${act.coupon ? '• Cupom: ' + act.coupon : ''}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-semibold text-gray-800">${act.price || 'N/A'}</p>
                            <p class="text-xs text-gray-400">${new Date(act.posted_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</p>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('recentActivity').innerHTML = html || '<p class="text-gray-500 text-sm">Nenhuma atividade recente</p>';
            } catch (err) {
                console.error('Failed to load recent activity:', err);
                document.getElementById('recentActivity').innerHTML = '<p class="text-gray-500 text-sm">Erro ao carregar atividades</p>';
            }
        }

        // Load Charts
        let weeklyChart = null;
        let categoryChart = null;
        
        async function loadCharts() {
            try {
                const response = await fetch('/api/charts');
                const data = await response.json();
                
                // Destroy existing charts
                if (weeklyChart) weeklyChart.destroy();
                if (categoryChart) categoryChart.destroy();
                
                // Weekly Posts Chart
                const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
                weeklyChart = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: data.weekly.labels,
                        datasets: [{
                            label: 'Postagens',
                            data: data.weekly.values,
                            backgroundColor: '#1e3a8a',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
                
                // Category Chart
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.categories.labels,
                        datasets: [{
                            data: data.categories.values,
                            backgroundColor: ['#1e3a8a', '#3b82f6', '#60a5fa', '#93c5fd', '#dbeafe']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            } catch (err) {
                console.error('Failed to load charts:', err);
            }
        }

        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch('/categories');
                const categories = await response.json();
                
                const html = categories.map(cat => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div>
                            <p class="font-medium text-gray-800">${cat.name_ia}</p>
                            <p class="text-sm text-gray-500">Thread ID: ${cat.thread_id}</p>
                        </div>
                        <button onclick="deleteCategory(${cat.id})" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('categoriesList').innerHTML = html || '<p class="text-gray-500 text-sm">Nenhuma categoria cadastrada</p>';
            } catch (err) {
                console.error('Failed to load categories:', err);
            }
        }

        // Add Category
        async function addCategory(event) {
            event.preventDefault();
            const name = document.getElementById('categoryName').value;
            const threadId = document.getElementById('categoryThreadId').value;
            
            try {
                const response = await fetch('/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name_ia: name, thread_id: threadId })
                });
                
                if (response.ok) {
                    showToast('Categoria adicionada com sucesso!', 'success');
                    document.getElementById('categoryName').value = '';
                    document.getElementById('categoryThreadId').value = '';
                    loadCategories();
                } else {
                    showToast('Erro ao adicionar categoria', 'error');
                }
            } catch (err) {
                showToast('Erro ao adicionar categoria', 'error');
            }
        }

        // Delete Category
        async function deleteCategory(id) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;
            
            try {
                const response = await fetch(`/categories/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Categoria excluída com sucesso!', 'success');
                    loadCategories();
                } else {
                    showToast('Erro ao excluir categoria', 'error');
                }
            } catch (err) {
                showToast('Erro ao excluir categoria', 'error');
            }
        }

        // Load Monitoring
        async function loadMonitoring() {
            try {
                const response = await fetch('/monitoring');
                const channels = await response.json();
                
                const html = channels.map(ch => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div>
                            <p class="font-medium text-gray-800">${ch.name || 'Canal'}</p>
                            <p class="text-sm text-gray-500">${ch.chat_id}</p>
                        </div>
                        <button onclick="deleteMonitoring(${ch.id})" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
                
                document.getElementById('monitoringList').innerHTML = html || '<p class="text-gray-500 text-sm">Nenhum canal monitorado</p>';
            } catch (err) {
                console.error('Failed to load monitoring:', err);
            }
        }

        // Add Monitoring
        async function addMonitoring(event) {
            event.preventDefault();
            const chatId = document.getElementById('monitorChatId').value;
            const name = document.getElementById('monitorName').value;
            
            try {
                const response = await fetch('/monitoring', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, name: name })
                });
                
                if (response.ok) {
                    showToast('Canal adicionado com sucesso!', 'success');
                    document.getElementById('monitorChatId').value = '';
                    document.getElementById('monitorName').value = '';
                    loadMonitoring();
                } else {
                    showToast('Erro ao adicionar canal', 'error');
                }
            } catch (err) {
                showToast('Erro ao adicionar canal', 'error');
            }
        }

        // Delete Monitoring
        async function deleteMonitoring(id) {
            if (!confirm('Tem certeza que deseja remover este canal?')) return;
            
            try {
                const response = await fetch(`/monitoring/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Canal removido com sucesso!', 'success');
                    loadMonitoring();
                } else {
                    showToast('Erro ao remover canal', 'error');
                }
            } catch (err) {
                showToast('Erro ao remover canal', 'error');
            }
        }

        // Update button text based on schedule time
        function updateButtonText() {
            const scheduleTime = document.getElementById('scheduleTime').value;
            const postButton = document.getElementById('postButton');
            
            if (scheduleTime) {
                postButton.innerHTML = '<i class="fas fa-clock mr-2"></i>Agendar Agora';
                postButton.className = 'flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors';
            } else {
                postButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Postar Agora';
                postButton.className = 'flex-1 px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg transition-colors';
            }
        }

        // Generate Preview
        async function generatePreview() {
            const content = document.getElementById('postContent').value;
            const imageFile = document.getElementById('postImage').files[0];
            
            if (!content) {
                showToast('Digite o conteúdo da oferta primeiro', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('content', content);
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                // Create Telegram-style message bubble
                let previewHTML = `
                    <div class="bg-gradient-to-b from-[#0088cc] to-[#006699] p-4">
                        <!-- Telegram Header -->
                        <div class="flex items-center mb-3 text-white text-sm">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center mr-2">
                                <i class="fas fa-store"></i>
                            </div>
                            <div>
                                <p class="font-semibold">Ofertas Sertão</p>
                                <p class="text-xs text-white/70">Bot</p>
                            </div>
                        </div>
                        
                        <!-- Message Bubble -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-sm">
                            ${data.imagePreview ? `
                                <div class="relative">
                                    <img src="${data.imagePreview}" alt="Preview" class="w-full h-auto">
                                </div>
                            ` : ''}
                            <div class="p-3 space-y-2">
                                <p class="font-semibold text-gray-900 text-base">${data.title || 'Produto'}</p>
                                ${data.price ? `<p class="text-green-600 font-bold text-lg">💰 ${data.price}</p>` : ''}
                                ${data.coupon ? `<p class="text-blue-600 text-sm">🎟️ Cupom: ${data.coupon}</p>` : ''}
                                ${data.links && data.links.length > 0 ? `
                                    <div class="space-y-1 pt-2 border-t border-gray-200">
                                        ${data.links.map(link => `<p class="text-xs text-blue-500 truncate">🔗 ${link}</p>`).join('')}
                                    </div>
                                ` : ''}
                                <p class="text-xs text-gray-500 pt-2">📢 Mais ofertas em: https://t.me/ofertasertao</p>
                            </div>
                            ${data.isDuplicate ? `
                                <div class="bg-red-50 border-t border-red-200 p-2">
                                    <p class="text-red-600 text-xs">⚠️ Esta oferta já foi postada nas últimas 24h</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Telegram Footer -->
                        <div class="text-white/50 text-xs mt-2">
                            <i class="fas fa-check-double"></i> ${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                    </div>
                `;
                
                document.getElementById('previewArea').innerHTML = previewHTML;
                showToast('Preview gerado com sucesso!', 'success');
            } catch (err) {
                console.error('Preview error:', err);
                showToast('Erro ao gerar preview', 'error');
            }
        }

        // Post Now
        async function postNow() {
            const content = document.getElementById('postContent').value;
            const scheduleTime = document.getElementById('scheduleTime').value;
            const imageFile = document.getElementById('postImage').files[0];
            
            if (!content) {
                showToast('Digite o conteúdo da oferta primeiro', 'error');
                return;
            }
            
            // Validate schedule time if provided
            if (scheduleTime) {
                const scheduledDate = new Date(scheduleTime);
                const now = new Date();
                
                if (scheduledDate <= now) {
                    showToast('A data deve ser no futuro', 'error');
                    return;
                }
            }
            
            try {
                const formData = new FormData();
                formData.append('content', content);
                if (scheduleTime) formData.append('scheduleTime', scheduleTime);
                if (imageFile) formData.append('image', imageFile);
                
                const response = await fetch('/api/post', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(scheduleTime ? 'Postagem agendada com sucesso!' : 'Postagem enviada com sucesso!', 'success');
                    document.getElementById('postContent').value = '';
                    document.getElementById('scheduleTime').value = '';
                    document.getElementById('postImage').value = '';
                    updateButtonText();
                    document.getElementById('previewArea').innerHTML = `
                        <div class="p-4 text-center text-white/60 text-sm">
                            <i class="fas fa-eye text-4xl mb-3 block opacity-50"></i>
                            Clique em "Gerar Preview" para visualizar
                        </div>
                    `;
                    if (scheduleTime) loadScheduledPosts();
                    loadRecentActivity();
                    loadMetrics();
                } else {
                    showToast(result.error || 'Erro ao enviar postagem', 'error');
                }
            } catch (err) {
                console.error('Post error:', err);
                showToast('Erro ao enviar postagem', 'error');
            }
        }

        // Clear Cache
        async function clearCache() {
            if (!confirm('Tem certeza que deseja limpar o cache?')) return;
            
            try {
                const response = await fetch('/api/clear-cache', { method: 'POST' });
                if (response.ok) {
                    showToast('Cache limpo com sucesso!', 'success');
                } else {
                    showToast('Erro ao limpar cache', 'error');
                }
            } catch (err) {
                showToast('Erro ao limpar cache', 'error');
            }
        }

        // Refresh Logs
        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                
                const html = logs.map(log => `
                    <div class="p-4 bg-gray-50 rounded-lg border-l-4 ${log.type === 'error' ? 'border-red-500' : log.type === 'success' ? 'border-green-500' : 'border-blue-500'}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${log.message}</p>
                                <p class="text-sm text-gray-500 mt-1">${log.details || ''}</p>
                            </div>
                            <span class="text-xs text-gray-400">${new Date(log.timestamp).toLocaleString('pt-BR')}</span>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('logsList').innerHTML = html || '<p class="text-gray-500 text-sm">Nenhum log disponível</p>';
            } catch (err) {
                console.error('Failed to load logs:', err);
            }
        }

        // Load Scheduled Posts
        async function loadScheduledPosts() {
            try {
                const response = await fetch('/api/scheduled');
                const posts = await response.json();
                
                const html = posts.map(post => `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-800">${post.preview}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(post.schedule_time).toLocaleString('pt-BR')}</p>
                            </div>
                            <button onclick="cancelScheduled(${post.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('scheduledPosts').innerHTML = html || '<p class="text-gray-500 text-sm">Nenhuma postagem agendada</p>';
            } catch (err) {
                console.error('Failed to load scheduled posts:', err);
            }
        }

        // Cancel Scheduled Post
        async function cancelScheduled(id) {
            if (!confirm('Tem certeza que deseja cancelar esta postagem agendada?')) return;
            
            try {
                const response = await fetch(`/api/scheduled/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('Postagem cancelada com sucesso!', 'success');
                    loadScheduledPosts();
                } else {
                    showToast('Erro ao cancelar postagem', 'error');
                }
            } catch (err) {
                console.error('Cancel error:', err);
                showToast('Erro ao cancelar postagem', 'error');
            }
        }

        // ============================================
        // WebSocket & Pending Promotions Functions
        // ============================================
        
        let ws = null;
        let wsReconnectAttempts = 0;
        let categoriesCache = [];
        
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            console.log('[WebSocket] Connecting to:', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('[WebSocket] Connected');
                wsReconnectAttempts = 0;
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('[WebSocket] Message:', message.type);
                    
                    switch (message.type) {
                        case 'pending_count_update':
                            updatePendingBadge(message.data.count);
                            break;
                        case 'new_pending_promotion':
                            showToast(`Nova promoção pendente: ${message.data.product_name || 'Produto'}`, 'info');
                            // If on promotions tab, reload the list
                            if (!document.getElementById('tab-promocoes').classList.contains('hidden')) {
                                loadPendingPromotions();
                            }
                            break;
                        case 'no_affiliate_count_update':
                            updateNoAffiliateBadge(message.data.count);
                            break;
                        case 'new_no_affiliate_promotion':
                            showToast(`Nova promoção sem afiliado: ${message.data.source || 'Loja'}`, 'warning');
                            // If on promotions tab, reload the list
                            if (!document.getElementById('tab-promocoes').classList.contains('hidden')) {
                                loadNoAffiliatePromotions();
                            }
                            break;
                        case 'queue_status_update':
                            updateQueueDisplay(message.data);
                            break;
                        case 'rate_limit_update':
                            updateRateLimitDisplay(message.data);
                            break;
                        case 'connection_status':
                            handleConnectionStatusUpdate(message);
                            break;
                        case 'pong':
                            // Connection alive
                            break;
                    }
                } catch (err) {
                    console.warn('[WebSocket] Message parse error:', err);
                }
            };
            
            ws.onclose = () => {
                console.log('[WebSocket] Disconnected');
                // Reconnect with exponential backoff
                const delay = Math.min(1000 * Math.pow(2, wsReconnectAttempts), 30000);
                wsReconnectAttempts++;
                setTimeout(initWebSocket, delay);
            };
            
            ws.onerror = (error) => {
                console.warn('[WebSocket] Error:', error);
            };
            
            // Send ping every 30s to keep connection alive
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
        }
        
        function updatePendingBadge(count) {
            const notifBadge = document.getElementById('notification-badge');
            const sidebarBadge = document.getElementById('sidebar-pending-badge');
            
            if (count > 0) {
                notifBadge.textContent = count > 99 ? '99+' : count;
                notifBadge.classList.remove('hidden');
                sidebarBadge.textContent = count > 99 ? '99+' : count;
                sidebarBadge.classList.remove('hidden');
            } else {
                notifBadge.classList.add('hidden');
                sidebarBadge.classList.add('hidden');
            }
        }
        
        async function loadCategoriesForSelect() {
            try {
                const res = await fetch('/api/categories');
                const data = await res.json();
                if (data.success) {
                    categoriesCache = data.data;
                }
            } catch (err) {
                console.error('Error loading categories:', err);
            }
        }
        
        function filterCategorySuggestions(searchTerm) {
            const suggestionsEl = document.getElementById('category-suggestions');
            
            if (!searchTerm || searchTerm.length < 1) {
                renderCategorySuggestions(categoriesCache);
                return;
            }
            
            const filtered = categoriesCache.filter(cat => 
                cat.name_ia.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            renderCategorySuggestions(filtered);
        }
        
        function renderCategorySuggestions(categories) {
            const suggestionsEl = document.getElementById('category-suggestions');
            
            if (!categories || categories.length === 0) {
                suggestionsEl.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">Nenhuma categoria encontrada</div>';
                suggestionsEl.classList.remove('hidden');
                return;
            }
            
            suggestionsEl.innerHTML = categories.map(cat => `
                <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer flex items-center justify-between transition-colors"
                     onclick="selectCategory('${cat.name_ia}', ${cat.thread_id})">
                    <span class="font-medium text-gray-800">${cat.name_ia}</span>
                    <span class="text-xs text-gray-400">Thread: ${cat.thread_id}</span>
                </div>
            `).join('');
            
            suggestionsEl.classList.remove('hidden');
        }
        
        function showCategorySuggestions() {
            const input = document.getElementById('edit-category');
            filterCategorySuggestions(input.value);
        }
        
        function selectCategory(name, threadId) {
            document.getElementById('edit-category').value = name;
            document.getElementById('edit-category-id').value = threadId;
            document.getElementById('category-suggestions').classList.add('hidden');
        }
        
        function useSuggestedCategory() {
            const suggested = document.getElementById('edit-suggested-category').textContent;
            if (suggested && suggested !== '-') {
                const cat = categoriesCache.find(c => c.name_ia.toLowerCase() === suggested.toLowerCase());
                if (cat) {
                    selectCategory(cat.name_ia, cat.thread_id);
                } else {
                    document.getElementById('edit-category').value = suggested;
                }
            }
        }
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestionsEl = document.getElementById('category-suggestions');
            const inputEl = document.getElementById('edit-category');
            if (suggestionsEl && !suggestionsEl.contains(e.target) && e.target !== inputEl) {
                suggestionsEl.classList.add('hidden');
            }
        });
        
        // Reanalyze all pending promotions with AI
        async function reanalyzeAllWithAI() {
            const btn = document.getElementById('btn-reanalyze-ai');
            const originalContent = btn.innerHTML;
            
            if (!confirm('Isso vai reprocessar todas as promoções pendentes pela IA.\n\nAs promoções serão removidas da lista de pendentes e adicionadas à fila de envio.\n\nSe a IA conseguir classificar, serão enviadas automaticamente.\nSe não conseguir, voltarão para esta lista.\n\nDeseja continuar?')) {
                return;
            }
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';
                
                const res = await fetch('/api/pending-promotions/reanalyze-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count} promoções adicionadas à fila para reanálise`, 'success');
                    loadPendingPromotions();
                } else {
                    showToast(data.error || 'Erro ao reanalisar promoções', 'error');
                }
            } catch (err) {
                console.error('Error reanalyzing promotions:', err);
                showToast('Erro ao reanalisar promoções', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Approve all pending promotions (AI fallback)
        async function approveAllPending() {
            if (!confirm('Aprovar TODAS as promoções pendentes?\n\nElas serão enviadas com a categoria sugerida pela IA ou "Outros".')) {
                return;
            }
            
            const btn = document.getElementById('btn-approve-all-pending');
            const originalContent = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Aprovando...';
                
                const res = await fetch('/api/pending-promotions/approve-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count} promoções aprovadas e adicionadas à fila`, 'success');
                    loadPendingPromotions();
                } else {
                    showToast(data.error || 'Erro ao aprovar promoções', 'error');
                }
            } catch (err) {
                console.error('Error approving all:', err);
                showToast('Erro ao aprovar promoções', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Reject all pending promotions (AI fallback)
        async function rejectAllPending() {
            if (!confirm('Recusar TODAS as promoções pendentes?\n\nEssa ação não pode ser desfeita.')) {
                return;
            }
            
            const btn = document.getElementById('btn-reject-all-pending');
            const originalContent = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Recusando...';
                
                const res = await fetch('/api/pending-promotions/reject-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count} promoções recusadas`, 'success');
                    loadPendingPromotions();
                } else {
                    showToast(data.error || 'Erro ao recusar promoções', 'error');
                }
            } catch (err) {
                console.error('Error rejecting all:', err);
                showToast('Erro ao recusar promoções', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Approve all no-affiliate promotions
        async function approveAllNoAffiliate() {
            if (!confirm('Aprovar TODAS as promoções sem afiliado?\n\nElas serão enviadas com a categoria "Outros".')) {
                return;
            }
            
            const btn = document.getElementById('btn-approve-all-noaff');
            const originalContent = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Aprovando...';
                
                const res = await fetch('/api/no-affiliate-promotions/approve-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count} promoções aprovadas e adicionadas à fila`, 'success');
                    loadNoAffiliatePromotions();
                } else {
                    showToast(data.error || 'Erro ao aprovar promoções', 'error');
                }
            } catch (err) {
                console.error('Error approving all no-affiliate:', err);
                showToast('Erro ao aprovar promoções', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        // Reject all no-affiliate promotions
        async function rejectAllNoAffiliate() {
            if (!confirm('Recusar TODAS as promoções sem afiliado?\n\nEssa ação não pode ser desfeita.')) {
                return;
            }
            
            const btn = document.getElementById('btn-reject-all-noaff');
            const originalContent = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Recusando...';
                
                const res = await fetch('/api/no-affiliate-promotions/reject-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(`${data.count} promoções recusadas`, 'success');
                    loadNoAffiliatePromotions();
                } else {
                    showToast(data.error || 'Erro ao recusar promoções', 'error');
                }
            } catch (err) {
                console.error('Error rejecting all no-affiliate:', err);
                showToast('Erro ao recusar promoções', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        async function loadPendingPromotions() {
            try {
                const res = await fetch('/api/pending-promotions');
                const data = await res.json();
                
                const listEl = document.getElementById('pending-promotions-list');
                const emptyEl = document.getElementById('pending-empty-state');
                
                if (!data.success || !data.data || data.data.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    return;
                }
                
                emptyEl.classList.add('hidden');
                
                listEl.innerHTML = data.data.map(promo => {
                    const sourceBadge = {
                        'shopee': 'bg-orange-100 text-orange-800',
                        'mercadolivre': 'bg-yellow-100 text-yellow-800',
                        'amazon': 'bg-blue-100 text-blue-800',
                        'aliexpress': 'bg-red-100 text-red-800',
                        'magalu': 'bg-blue-100 text-blue-800',
                        'telegram_monitor': 'bg-purple-100 text-purple-800',
                        'manual': 'bg-gray-100 text-gray-800'
                    }[promo.source] || 'bg-gray-100 text-gray-800';
                    
                    // Truncate description for display (first 200 chars)
                    const descriptionPreview = (promo.processed_text || promo.original_text || '').substring(0, 200);
                    const hasMore = (promo.processed_text || promo.original_text || '').length > 200;
                    
                    return `
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                        <div class="flex items-start gap-4">
                            ${promo.image_path ? `<img src="${promo.image_path}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.style.display='none'">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${sourceBadge}">${promo.source}</span>
                                    <span class="text-xs text-gray-500">${new Date(promo.created_at).toLocaleString('pt-BR')}</span>
                                </div>
                                <h4 class="font-semibold text-gray-800">${promo.product_name || 'Produto sem nome'}</h4>
                                <div class="flex items-center gap-4 mt-1 text-sm text-gray-600">
                                    ${promo.price ? `<span class="text-green-600 font-medium">${promo.price}</span>` : ''}
                                    ${promo.coupon ? `<span><i class="fas fa-ticket-alt mr-1"></i>${promo.coupon}</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-500 mt-2 whitespace-pre-line break-all">${descriptionPreview}${hasMore ? '...' : ''}</p>
                                ${promo.suggested_category ? `<p class="text-xs text-blue-500 mt-2"><i class="fas fa-robot mr-1"></i>Sugestão IA: ${promo.suggested_category}</p>` : ''}
                            </div>
                            <div class="flex flex-col gap-2 flex-shrink-0">
                                <button onclick="openEditModal(${promo.id})" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="quickApprove(${promo.id})" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                                    <i class="fas fa-check mr-1"></i>Aprovar
                                </button>
                                <button onclick="rejectPromotion(${promo.id})" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm">
                                    <i class="fas fa-times mr-1"></i>Excluir
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                // Update badge
                updatePendingBadge(data.data.length);
            } catch (err) {
                console.error('Error loading pending promotions:', err);
                showToast('Erro ao carregar promoções pendentes', 'error');
            }
        }
        
        async function openEditModal(id) {
            try {
                // Load categories if not cached
                if (categoriesCache.length === 0) {
                    await loadCategoriesForSelect();
                }
                
                const res = await fetch(`/api/pending-promotions/${id}`);
                const data = await res.json();
                
                if (!data.success || !data.data) {
                    showToast('Promoção não encontrada', 'error');
                    return;
                }
                
                const promo = data.data;
                
                document.getElementById('edit-promo-id').value = promo.id;
                document.getElementById('edit-product-name').value = promo.product_name || '';
                document.getElementById('edit-price').value = promo.price || '';
                document.getElementById('edit-coupon').value = promo.coupon || '';
                document.getElementById('edit-category').value = promo.suggested_category || '';
                document.getElementById('edit-processed-text').value = promo.processed_text || promo.original_text || '';
                document.getElementById('edit-suggested-category').textContent = promo.suggested_category || 'Nenhuma sugestão';
                
                // Carregar imagem se existir
                const imagePreview = document.getElementById('edit-image-preview');
                const imagePlaceholder = document.getElementById('edit-image-placeholder');
                const btnRemoveImage = document.getElementById('btn-remove-image');
                const imagePathInput = document.getElementById('edit-image-path');
                
                if (promo.image_path) {
                    imagePreview.src = promo.image_path;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                    btnRemoveImage.classList.remove('hidden');
                    imagePathInput.value = promo.image_path;
                } else {
                    imagePreview.src = '';
                    imagePreview.classList.add('hidden');
                    imagePlaceholder.classList.remove('hidden');
                    btnRemoveImage.classList.add('hidden');
                    imagePathInput.value = '';
                }
                
                // Limpar input de upload
                document.getElementById('edit-image-upload').value = '';
                
                document.getElementById('edit-promotion-modal').classList.remove('hidden');
            } catch (err) {
                console.error('Error opening edit modal:', err);
                showToast('Erro ao carregar dados da promoção', 'error');
            }
        }
        
        function closeEditModal() {
            document.getElementById('edit-promotion-modal').classList.add('hidden');
        }
        
        // Funções de manipulação de imagem no modal de edição
        async function handleEditImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validar tamanho (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Imagem muito grande! Máximo 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            // Validar tipo
            if (!file.type.startsWith('image/')) {
                showToast('Arquivo deve ser uma imagem', 'error');
                event.target.value = '';
                return;
            }
            
            // Upload da imagem
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                showToast('Enviando imagem...', 'info');
                const res = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // Atualizar preview
                    const imagePreview = document.getElementById('edit-image-preview');
                    const imagePlaceholder = document.getElementById('edit-image-placeholder');
                    const btnRemoveImage = document.getElementById('btn-remove-image');
                    const imagePathInput = document.getElementById('edit-image-path');
                    
                    imagePreview.src = data.path;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                    btnRemoveImage.classList.remove('hidden');
                    imagePathInput.value = data.path;
                    
                    showToast('Imagem enviada com sucesso!', 'success');
                } else {
                    showToast(data.error || 'Erro ao enviar imagem', 'error');
                }
            } catch (err) {
                console.error('Error uploading image:', err);
                showToast('Erro ao enviar imagem', 'error');
            }
        }
        
        function removeEditImage() {
            const imagePreview = document.getElementById('edit-image-preview');
            const imagePlaceholder = document.getElementById('edit-image-placeholder');
            const btnRemoveImage = document.getElementById('btn-remove-image');
            const imagePathInput = document.getElementById('edit-image-path');
            
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');
            btnRemoveImage.classList.add('hidden');
            imagePathInput.value = '';
            
            // Limpar input de upload
            document.getElementById('edit-image-upload').value = '';
        }
        
        async function savePromotion() {
            const id = document.getElementById('edit-promo-id').value;
            const data = {
                product_name: document.getElementById('edit-product-name').value,
                price: document.getElementById('edit-price').value,
                coupon: document.getElementById('edit-coupon').value,
                category: document.getElementById('edit-category').value,
                processed_text: document.getElementById('edit-processed-text').value,
                image_path: document.getElementById('edit-image-path').value
            };
            
            try {
                const res = await fetch(`/api/pending-promotions/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showToast('Promoção atualizada com sucesso!', 'success');
                    loadPendingPromotions();
                } else {
                    showToast('Erro ao atualizar promoção', 'error');
                }
            } catch (err) {
                console.error('Error saving promotion:', err);
                showToast('Erro ao salvar', 'error');
            }
        }
        
        async function approvePromotion() {
            const id = document.getElementById('edit-promo-id').value;
            const category = document.getElementById('edit-category').value;
            
            if (!category) {
                showToast('Selecione uma categoria antes de aprovar', 'error');
                return;
            }
            
            try {
                // First save any changes
                await savePromotion();
                
                const res = await fetch(`/api/pending-promotions/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    const position = data.position ? ` (posição ${data.position} na fila)` : '';
                    showToast(`Promoção aprovada e adicionada à fila de envio!${position}`, 'success');
                    closeEditModal();
                    loadPendingPromotions();
                } else {
                    if ((data.error || '').includes('Promoção duplicada detectada')) {
                        showToast('Promoção duplicada detectada', 'warning');
                        closeEditModal();
                        // Remove the duplicate from the list in the UI
                        // Find the card for this promo and remove it
                        const promoCards = document.querySelectorAll('#pending-promotions-list .border.rounded-lg');
                        for (const card of promoCards) {
                            if (card.querySelector(`button[onclick*="openEditModal(${id})"]`)) {
                                card.remove();
                                break;
                            }
                        }
                        // Optionally, reload the list to ensure consistency
                        loadPendingPromotions();
                    } else {
                        showToast(data.error || 'Erro ao aprovar promoção', 'error');
                    }
                }
            } catch (err) {
                console.error('Error approving promotion:', err);
                showToast('Erro ao aprovar', 'error');
            }
        }
        
        async function quickApprove(id) {
            // Open modal for category selection
            await openEditModal(id);
            // Or implement a quick dropdown? For now just open the modal.
        }
        
        async function rejectPromotion(id) {
            if (!confirm('Tem certeza que deseja excluir esta promoção?')) return;
            
            try {
                const res = await fetch(`/api/pending-promotions/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Excluída manualmente' })
                });
                
                if (res.ok) {
                    showToast('Promoção excluída', 'success');
                    loadPendingPromotions();
                    loadNoAffiliatePromotions(); // Also refresh no-affiliate list
                } else {
                    showToast('Erro ao excluir promoção', 'error');
                }
            } catch (err) {
                console.error('Error rejecting promotion:', err);
                showToast('Erro ao excluir', 'error');
            }
        }

        // ==================== NO AFFILIATE PROMOTIONS ====================
        
        async function loadNoAffiliatePromotions() {
            try {
                const res = await fetch('/api/no-affiliate-promotions');
                const data = await res.json();
                
                const listEl = document.getElementById('no-affiliate-list');
                const emptyEl = document.getElementById('no-affiliate-empty-state');
                
                if (!data.success || !data.data || data.data.length === 0) {
                    listEl.innerHTML = '';
                    emptyEl.classList.remove('hidden');
                    updateNoAffiliateBadge(0);
                    return;
                }
                
                emptyEl.classList.add('hidden');
                
                listEl.innerHTML = data.data.map(promo => {
                    const sourceBadge = {
                        'kabum': 'bg-orange-100 text-orange-800',
                        'pichau': 'bg-green-100 text-green-800',
                        'terabyte': 'bg-blue-100 text-blue-800',
                        'magalu': 'bg-blue-100 text-blue-800',
                        'casasbahia': 'bg-red-100 text-red-800',
                        'americanas': 'bg-red-100 text-red-800'
                    }[promo.source] || 'bg-gray-100 text-gray-800';
                    
                    // Truncate description for display (first 200 chars)
                    const descriptionPreview = (promo.processed_text || promo.original_text || '').substring(0, 200);
                    const hasMore = (promo.processed_text || promo.original_text || '').length > 200;
                    
                    // Get first URL for display
                    const firstUrl = (promo.urls && promo.urls.length > 0) ? promo.urls[0] : '';
                    const urlPreview = firstUrl.length > 50 ? firstUrl.substring(0, 50) + '...' : firstUrl;
                    
                    return `
                    <div class="border border-orange-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-orange-50">
                        <div class="flex items-start gap-4">
                            ${promo.image_path ? `<img src="${promo.image_path}" class="w-20 h-20 object-cover rounded-lg flex-shrink-0" onerror="this.style.display='none'">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${sourceBadge}">${promo.source}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-orange-200 text-orange-800"><i class="fas fa-unlink mr-1"></i>Sem Afiliado</span>
                                    <span class="text-xs text-gray-500">${new Date(promo.created_at).toLocaleString('pt-BR')}</span>
                                </div>
                                <h4 class="font-semibold text-gray-800">${promo.product_name || 'Produto sem nome'}</h4>
                                ${firstUrl ? `<p class="text-xs text-blue-600 mt-1 truncate"><i class="fas fa-link mr-1"></i><a href="${firstUrl}" target="_blank" class="hover:underline">${urlPreview}</a></p>` : ''}
                                <p class="text-sm text-gray-500 mt-2 whitespace-pre-line break-all">${descriptionPreview}${hasMore ? '...' : ''}</p>
                            </div>
                            <div class="flex flex-col gap-2 flex-shrink-0">
                                <button onclick="openEditModal(${promo.id})" class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="approveNoAffiliate(${promo.id})" class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm" title="Aprovar e enviar sem link de afiliado">
                                    <i class="fas fa-check mr-1"></i>Aprovar
                                </button>
                                <button onclick="rejectPromotion(${promo.id})" class="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm">
                                    <i class="fas fa-times mr-1"></i>Excluir
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                // Update badge
                updateNoAffiliateBadge(data.data.length);
            } catch (err) {
                console.error('Error loading no-affiliate promotions:', err);
            }
        }
        
        function updateNoAffiliateBadge(count) {
            const badge = document.getElementById('no-affiliate-badge');
            if (badge) {
                badge.textContent = count;
                badge.classList.toggle('hidden', count === 0);
            }
        }
        
        async function approveNoAffiliate(id) {
            // Show confirmation since it has no affiliate link
            if (!confirm('Esta promoção não tem link de afiliado. Deseja enviar mesmo assim? (não gerará comissão)')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/pending-promotions/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: 'Outros' }) // Default category for no-affiliate
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    const position = data.position ? ` (posição ${data.position} na fila)` : '';
                    showToast(`Promoção adicionada à fila de envio!${position}`, 'success');
                    loadNoAffiliatePromotions();
                } else {
                    showToast(data.error || 'Erro ao aprovar promoção', 'error');
                }
            } catch (err) {
                console.error('Error approving no-affiliate:', err);
                showToast('Erro ao aprovar', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            let sidebarOpen = true;

            sidebarToggle.addEventListener('click', () => {
                sidebarOpen = !sidebarOpen;
                
                if (sidebarOpen) {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                    mainContent.classList.add('ml-64');
                    sidebarToggle.classList.add('sidebar-open');
                } else {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                    mainContent.classList.remove('ml-64');
                    sidebarToggle.classList.remove('sidebar-open');
                }
            });

            // Initialize WebSocket
            initWebSocket();
            
            // Load initial pending count
            fetch('/api/pending-promotions/count')
                .then(res => res.json())
                .then(data => {
                    if (data.success) updatePendingBadge(data.count);
                })
                .catch(err => console.warn('Error loading pending count:', err));
            
            // Load initial no-affiliate count
            fetch('/api/no-affiliate-promotions/count')
                .then(res => res.json())
                .then(data => {
                    if (data.success) updateNoAffiliateBadge(data.count);
                })
                .catch(err => console.warn('Error loading no-affiliate count:', err));
            
            loadMetrics();
            loadCharts();
            loadCategories();
            loadMonitoring();
            loadRecentActivity();
            loadScheduledPosts();
            checkAPIStatus();
            refreshLogs();
            loadForbiddenWords();
            loadExcludedUrls(); // Load excluded URL patterns
            loadSettings(); // Load SaaS settings
            checkUserMonitorStatus(); // Check user monitor status
            checkCookieStatus(); // Check cookie capture status
            
            // Refresh metrics every 30s
            setInterval(() => {
                loadMetrics();
                loadRecentActivity();
                checkAPIStatus();
            }, 30000);
        });

        // --- Forbidden Words Functions ---
        async function loadForbiddenWords() {
            try {
                const response = await fetch('/api/forbidden-words');
                const words = await response.json();
                
                const html = words.map(wordObj => {
                    const word = typeof wordObj === 'string' ? wordObj : wordObj.word;
                    const id = wordObj.id; // May be undefined if just strings
                    const display = word.toLowerCase();
                    // If we have ID, we can delete properly. 
                    // Backend returns getAllWithIds? Let's check. 
                    // grep said await ForbiddenWords.getAllWithIds();
                    // But model says getAll() returns strings.
                    // Let's assume the endpoint returns helper with IDs or stick to strings if simple.
                    // grep of server.js line 627: const words = await ForbiddenWords.getAllWithIds();
                    // So it returns objects {id, word}.
                    
                    return `
                    <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm flex items-center gap-2">
                        ${display}
                        <button onclick="deleteForbiddenWord(${id})" class="hover:text-red-900 font-bold">&times;</button>
                    </span>`;
                }).join('');
                
                document.getElementById('forbiddenWordsList').innerHTML = html || '<span class="text-gray-500 italic">Nenhuma palavra proibida.</span>';
            } catch (err) {
                console.error('Failed to load forbidden words:', err);
                document.getElementById('forbiddenWordsList').innerHTML = '<span class="text-red-500">Erro ao carregar.</span>';
            }
        }

        async function addForbiddenWord(event) {
            event.preventDefault();
            const input = document.getElementById('forbiddenWord');
            const word = input.value.trim();
            if(!word) return;

            try {
                const res = await fetch('/api/forbidden-words', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ word })
                });
                if(res.ok) {
                    showToast('Palavra adicionada!', 'success');
                    input.value = '';
                    loadForbiddenWords();
                } else {
                    showToast('Erro ao adicionar.', 'error');
                }
            } catch(err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        async function deleteForbiddenWord(id) {
            if(!confirm('Remover esta palavra proibida?')) return;
            try {
                const res = await fetch(`/api/forbidden-words/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    showToast('Palavra removida!', 'success');
                    loadForbiddenWords();
                } else {
                    showToast('Erro ao remover.', 'error');
                }
            } catch(err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        // --- Excluded URLs Functions ---

        async function loadExcludedUrls() {
            try {
                const res = await fetch('/api/excluded-urls');
                const data = await res.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    document.getElementById('excludedUrlsList').innerHTML = '<p class="text-gray-500 text-sm italic">Nenhum padrão de URL excluído.</p>';
                    return;
                }
                
                const html = data.data.map(item => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${item.active ? '' : 'opacity-50'}">
                        <div class="flex-1">
                            <code class="text-sm font-mono text-red-600">${item.pattern}</code>
                            ${item.description ? `<span class="text-sm text-gray-500 ml-2">- ${item.description}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleExcludedUrl(${item.id})" class="px-3 py-1 text-sm rounded ${item.active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}" title="${item.active ? 'Ativo - Clique para desativar' : 'Inativo - Clique para ativar'}">
                                <i class="fas fa-${item.active ? 'check' : 'pause'}"></i>
                            </button>
                            <button onclick="deleteExcludedUrl(${item.id})" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('excludedUrlsList').innerHTML = html;
            } catch (err) {
                console.error('Error loading excluded URLs:', err);
                document.getElementById('excludedUrlsList').innerHTML = '<p class="text-red-500 text-sm">Erro ao carregar.</p>';
            }
        }

        async function addExcludedUrl(event) {
            event.preventDefault();
            const patternInput = document.getElementById('excludedUrlPattern');
            const descInput = document.getElementById('excludedUrlDescription');
            
            const pattern = patternInput.value.trim();
            const description = descInput.value.trim();
            
            if (!pattern) return;
            
            try {
                const res = await fetch('/api/excluded-urls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pattern, description })
                });
                
                if (res.ok) {
                    showToast('Padrão de URL adicionado!', 'success');
                    patternInput.value = '';
                    descInput.value = '';
                    loadExcludedUrls();
                } else {
                    showToast('Erro ao adicionar.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        async function toggleExcludedUrl(id) {
            try {
                const res = await fetch(`/api/excluded-urls/${id}/toggle`, { method: 'POST' });
                if (res.ok) {
                    loadExcludedUrls();
                } else {
                    showToast('Erro ao alterar status.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        async function deleteExcludedUrl(id) {
            if (!confirm('Remover este padrão de URL?')) return;
            
            try {
                const res = await fetch(`/api/excluded-urls/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Padrão removido!', 'success');
                    loadExcludedUrls();
                } else {
                    showToast('Erro ao remover.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        // --- SaaS Settings Functions ---

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();
                
                // Generic Generic population based on ID pattern "setting_KEY"
                // This covers all keys returned by the API
                for (const [key, value] of Object.entries(settings)) {
                    const el = document.getElementById('setting_' + key);
                    if (el) {
                        // Handle checkboxes differently
                        if (el.type === 'checkbox') {
                            el.checked = value === 'true' || value === true || value === '1';
                        } else {
                            el.value = value || '';
                        }
                    }
                }
                
                // Fallbacks for specific legacy/alias keys if needed
                if(settings.TELEGRAM_BOT_TOKEN && !settings.TELEGRAM_TOKEN) {
                     const el = document.getElementById('setting_TELEGRAM_TOKEN');
                     if(el) el.value = settings.TELEGRAM_BOT_TOKEN;
                }

                // Apply visual theme immediately
                applyTheme(settings);
            } catch (err) {
                console.error('Error loading settings:', err);
                showToast('Erro ao carregar configurações', 'error');
            }
        }

        async function saveSettings() {
            const data = {};
            
            // Automatically collect all inputs starting with "setting_"
            const inputs = document.querySelectorAll('[id^="setting_"]');
            inputs.forEach(input => {
                const key = input.id.replace('setting_', '');
                if (key) {
                    // Handle checkboxes differently
                    if (input.type === 'checkbox') {
                        data[key] = input.checked ? 'true' : 'false';
                    } else {
                        data[key] = input.value;
                    }
                }
            });

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showToast('Configurações salvas com sucesso!', 'success');
                    loadSettings(); // Reload to confirm and apply
                } else {
                    showToast('Erro ao salvar configurações.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Erro de conexão.', 'error');
            }
        }

        async function uploadLogo() {
            const input = document.getElementById('logoInput');
            if (input.files.length === 0) {
                showToast('Selecione uma imagem primeiro.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('logo', input.files[0]);

            try {
                const res = await fetch('/api/upload/logo', {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    showToast('Logo atualizado com sucesso!', 'success');
                    // Update the image src specifically to force reload
                    const timestamp = new Date().getTime();
                    const mainLogo = document.getElementById('main-logo');
                    const previewLogo = document.getElementById('preview-logo');
                    if(mainLogo) mainLogo.src = '/img/logo.png?t=' + timestamp;
                    if(previewLogo) previewLogo.src = '/img/logo.png?t=' + timestamp;
                } else {
                    showToast('Erro ao enviar logo.', 'error');
                }
            } catch(err) {
                console.error(err);
                showToast('Erro no upload.', 'error');
            }
        }

        async function restartBot() {
            if(!confirm('Isso irá reiniciar o Bot do Telegram com as novas configurações. O serviço ficará indisponível por alguns segundos. Continuar?')) return;
            
            try {
                const res = await fetch('/api/settings/restart-bot', { method: 'POST' });
                const json = await res.json();
                if(json.success) {
                    showToast(json.message, 'success');
                } else {
                    showToast('Falha ao reiniciar: ' + json.message, 'error');
                }
            } catch(err) {
                showToast('Erro ao tentar reiniciar o bot.', 'error');
            }
        }

        function downloadBackup() {
            window.location.href = '/api/backup/export';
        }

        function applyTheme(settings) {
            // Apply Colors
            if (settings.THEME_COLOR_PRIMARY) {
                // Sidebar
                const sidebar = document.querySelector('.bg-blue-900'); 
                if(sidebar) sidebar.classList.remove('bg-blue-900');
                if(sidebar) sidebar.style.backgroundColor = settings.THEME_COLOR_PRIMARY;
                
                // Active Nav Items
                document.querySelectorAll('.bg-blue-700').forEach(el => el.style.backgroundColor = settings.THEME_COLOR_SECONDARY || settings.THEME_COLOR_PRIMARY);

                // Primary Buttons
                document.querySelectorAll('.bg-green-600').forEach(btn => btn.style.backgroundColor = settings.THEME_COLOR_PRIMARY);
            }

            // Apply Font
            if (settings.THEME_FONT_URL) {
                // Check if link exists
                let link = document.getElementById('theme-font-link');
                if (!link) {
                    link = document.createElement('link');
                    link.id = 'theme-font-link';
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                link.href = settings.THEME_FONT_URL;

                // Extract Font Family from URL if possible, or assume user knows CSS?
                // Actually, usually you need to specify the family.
                // But simplified: We might need a separate field for 'Font Family Name'.
                // If the user pastes a Google Fonts URL, we can't easily guess the family name without parsing.
                // Let's assume the user pastes the URL, and we might need an input for the name.
                // Or, more advanced: fetch the CSS and parse it.
                // For now, let's just add the stylesheet. The user might need to inspect element to see it working? 
                // No, that's bad UX.
                // I'll add "font-family: 'Roboto', sans-serif;" to body if I knew the name.
                // Let's rely on a smart guess or just ask the user for the name.
                // For this iteration, I'll just load the font. The user said "Adjust font also (putting the font link)".
                // Maybe they just want the link injected.
                // I'll try to apply it to body if I can find the family name in the URL...
                // URL example: ...?family=Roboto:wght@400...
                
                try {
                    const url = new URL(settings.THEME_FONT_URL);
                    const familyParam = url.searchParams.get('family');
                    if (familyParam) {
                        // "Roboto:wght@400;700" -> "Roboto"
                        const familyName = familyParam.split(':')[0];
                        document.body.style.fontFamily = `'${familyName.replace(/\+/g, ' ')}', sans-serif`;
                    }
                } catch (e) {
                    console.error('Could not parse font family from URL');
                }
            }
        }

        // --- Queue & Rate Limit Functions ---
        
        function formatTime(seconds) {
            if (seconds < 60) return `${Math.round(seconds)}s`;
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}m ${secs}s`;
        }

        function updateQueueDisplay(data) {
            // Update dashboard cards
            const queueLength = document.getElementById('queue-length');
            const queueEta = document.getElementById('queue-eta');
            const queueDelay = document.getElementById('queue-delay');
            const queueAvgWait = document.getElementById('queue-avg-wait');
            const queueStatusBadge = document.getElementById('queue-status-badge');

            if (queueLength) queueLength.textContent = data.queueLength || 0;
            if (queueEta) queueEta.textContent = formatTime(data.estimatedTimeSeconds || 0);
            if (queueDelay) queueDelay.textContent = data.promotionDelay || 10;
            if (queueAvgWait) queueAvgWait.textContent = Math.round(data.avgWaitTimeSeconds || 0);
            
            if (queueStatusBadge) {
                if (data.isProcessing) {
                    queueStatusBadge.textContent = 'Processando';
                    queueStatusBadge.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-600';
                } else if (data.queueLength > 0) {
                    queueStatusBadge.textContent = 'Aguardando';
                    queueStatusBadge.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-600';
                } else {
                    queueStatusBadge.textContent = 'Parado';
                    queueStatusBadge.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600';
                }
            }
        }

        function updateRateLimitDisplay(data) {
            // Dashboard rate limit card
            const rateCurrent = document.getElementById('rate-current');
            const rateMax = document.getElementById('rate-max');
            const rateWindow = document.getElementById('rate-window');
            const rateRemaining = document.getElementById('rate-remaining');
            const rateProgress = document.getElementById('rate-progress');
            const rateCooldown = document.getElementById('rate-cooldown');
            const rateCooldownContainer = document.getElementById('rate-cooldown-container');
            const rateStatusText = document.getElementById('rate-status-text');

            if (rateCurrent) rateCurrent.textContent = data.current || 0;
            if (rateMax) rateMax.textContent = data.maxMessages || 5;
            if (rateWindow) rateWindow.textContent = data.timeWindowSeconds || 60;
            if (rateRemaining) rateRemaining.textContent = data.remaining || data.maxMessages || 5;
            
            // Update cooldown display
            const timeUntilNext = data.timeUntilNext || 0;
            if (rateCooldown) rateCooldown.textContent = formatTime(timeUntilNext);
            
            // Update cooldown container style based on status
            if (rateCooldownContainer) {
                if (timeUntilNext > 0) {
                    rateCooldownContainer.className = 'text-center p-3 bg-red-50 rounded-lg animate-pulse';
                    if (rateCooldown) rateCooldown.className = 'text-xl font-bold text-red-600';
                } else {
                    rateCooldownContainer.className = 'text-center p-3 bg-green-50 rounded-lg';
                    if (rateCooldown) rateCooldown.className = 'text-xl font-bold text-green-600';
                }
            }
            
            // Update status text
            if (rateStatusText) {
                const remaining = data.remaining || data.maxMessages || 5;
                if (timeUntilNext > 0) {
                    rateStatusText.textContent = `⏳ Rate limit atingido! Aguarde ${formatTime(timeUntilNext)}`;
                    rateStatusText.className = 'text-xs text-red-500 mt-1 text-center font-medium';
                } else if (remaining <= 1) {
                    rateStatusText.textContent = `⚠️ Quase no limite - ${remaining} mensagem restante`;
                    rateStatusText.className = 'text-xs text-yellow-500 mt-1 text-center font-medium';
                } else {
                    rateStatusText.textContent = `✅ Disponível para enviar (${remaining} restantes)`;
                    rateStatusText.className = 'text-xs text-green-500 mt-1 text-center font-medium';
                }
            }
            
            if (rateProgress) {
                const percentage = ((data.current || 0) / (data.maxMessages || 5)) * 100;
                rateProgress.style.width = `${Math.min(percentage, 100)}%`;
                
                // Change color based on usage
                if (percentage >= 80) {
                    rateProgress.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
                } else if (percentage >= 50) {
                    rateProgress.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
                } else {
                    rateProgress.className = 'bg-orange-500 h-2 rounded-full transition-all duration-300';
                }
            }

            // Config section rate limit display
            const rateConfigCurrent = document.getElementById('rate-config-current');
            const rateConfigMax = document.getElementById('rate-config-max');
            const rateConfigRemaining = document.getElementById('rate-config-remaining');
            const rateConfigReset = document.getElementById('rate-config-reset');

            if (rateConfigCurrent) rateConfigCurrent.textContent = data.current || 0;
            if (rateConfigMax) rateConfigMax.textContent = data.maxMessages || 5;
            if (rateConfigRemaining) rateConfigRemaining.textContent = data.remaining || data.maxMessages || 5;
            if (rateConfigReset) rateConfigReset.textContent = formatTime(data.timeUntilNext || 0);
        }

        // Handle Telegram MTProto connection status updates
        function handleConnectionStatusUpdate(message) {
            const status = message.status;
            const statusMsg = message.message;
            const statusDot = document.getElementById('userMonitorStatusDot');
            const statusText = document.getElementById('userMonitorStatusText');
            
            switch (status) {
                case 'disconnected':
                    showToast(statusMsg || 'Conexão Telegram perdida', 'error');
                    if (statusDot) statusDot.className = 'w-3 h-3 rounded-full bg-red-400 animate-pulse';
                    if (statusText) {
                        statusText.textContent = '⚠️ Desconectado (reconectando...)';
                        statusText.className = 'text-sm text-red-600';
                    }
                    break;
                    
                case 'reconnecting':
                    showToast(`Tentando reconectar (${message.attempt}/${message.maxAttempts})...`, 'warning');
                    if (statusDot) statusDot.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
                    if (statusText) {
                        statusText.textContent = `🔄 Reconectando (${message.attempt}/${message.maxAttempts})...`;
                        statusText.className = 'text-sm text-yellow-600';
                    }
                    break;
                    
                case 'connected':
                    showToast(statusMsg || 'Reconectado com sucesso!', 'success');
                    if (statusDot) statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                    if (statusText) {
                        statusText.textContent = '✅ Conectado';
                        statusText.className = 'text-sm text-green-600';
                    }
                    // Refresh monitor status to get full details
                    checkUserMonitorStatus();
                    break;
                    
                case 'failed':
                    showToast(statusMsg || 'Falha ao reconectar', 'error');
                    if (statusDot) statusDot.className = 'w-3 h-3 rounded-full bg-red-600';
                    if (statusText) {
                        statusText.textContent = '❌ Falhou - Reconectar manualmente';
                        statusText.className = 'text-sm text-red-600 font-medium';
                    }
                    break;
                    
                case 'error':
                    showToast(statusMsg || 'Erro de conexão', 'error');
                    break;
            }
        }

        async function loadQueueStatus() {
            try {
                const res = await fetch('/api/queue/status');
                if (res.ok) {
                    const data = await res.json();
                    updateQueueDisplay(data);
                }
            } catch (err) {
                console.error('Error loading queue status:', err);
            }
        }

        async function loadRateLimitStatus() {
            try {
                const res = await fetch('/api/rate-limit/status');
                if (res.ok) {
                    const data = await res.json();
                    updateRateLimitDisplay(data);
                }
            } catch (err) {
                console.error('Error loading rate limit status:', err);
            }
        }

        async function loadRateLimitSettings() {
            try {
                const res = await fetch('/api/rate-limit/settings');
                if (res.ok) {
                    const data = await res.json();
                    const maxInput = document.getElementById('rate-limit-max');
                    const windowInput = document.getElementById('rate-limit-window');
                    
                    if (maxInput) maxInput.value = data.maxMessages || 5;
                    if (windowInput) windowInput.value = data.timeWindowSeconds || 60;
                }
            } catch (err) {
                console.error('Error loading rate limit settings:', err);
            }
        }

        async function saveRateLimitSettings() {
            const maxMessages = parseInt(document.getElementById('rate-limit-max').value) || 5;
            const timeWindowSeconds = parseInt(document.getElementById('rate-limit-window').value) || 60;

            // Validate
            if (maxMessages < 1 || maxMessages > 30) {
                showToast('Máximo de mensagens deve ser entre 1 e 30', 'error');
                return;
            }
            if (timeWindowSeconds < 10 || timeWindowSeconds > 300) {
                showToast('Janela de tempo deve ser entre 10 e 300 segundos', 'error');
                return;
            }

            try {
                const res = await fetch('/api/rate-limit/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ maxMessages, timeWindowSeconds })
                });

                if (res.ok) {
                    showToast('Rate limit atualizado com sucesso!', 'success');
                    loadRateLimitStatus();
                } else {
                    const error = await res.json();
                    showToast(error.error || 'Erro ao salvar rate limit', 'error');
                }
            } catch (err) {
                console.error('Error saving rate limit:', err);
                showToast('Erro de conexão', 'error');
            }
        }

        // Load queue and rate limit status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initial load of queue and rate limit
            loadQueueStatus();
            loadRateLimitStatus();
            loadRateLimitSettings();

            // Refresh rate limit status every 5 seconds for accurate countdown
            setInterval(() => {
                loadRateLimitStatus();
            }, 5000);

            // Refresh queue status every 30 seconds as fallback (WebSocket should handle real-time)
            setInterval(() => {
                loadQueueStatus();
            }, 30000);
        });
    </script>
</body>
</html>
