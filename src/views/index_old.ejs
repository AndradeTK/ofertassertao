<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ofertas Sert√£o ‚Äî Painel</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    </head>
    <body class="min-h-screen bg-gray-50 text-gray-800">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center gap-3">
                        <img src="/img/logo.jpeg" alt="Ofertas Sert√£o" class="h-12 w-12 rounded-md object-cover shadow" />
                        <div>
                            <h1 class="text-lg font-semibold">Ofertas Sert√£o</h1>
                            <p class="text-sm text-gray-500">Gerenciador de Afiliados Automatizado</p>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button onclick="clearCache()" class="inline-flex items-center px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors">
                            <i class="fa-solid fa-trash mr-2"></i>Limpar Cache (Teste)
                        </button>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-50 text-green-700 font-medium">
                                <i class="fa-solid fa-robot mr-2"></i>Bot Online
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left column: forms -->
                <div class="space-y-6">
                    <section class="bg-white p-6 rounded-xl shadow border">
                        <h2 class="text-lg font-semibold mb-4">Nova Categoria</h2>
                        <form action="/categories" method="POST" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nome para IA</label>
                                <input
                                    type="text"
                                    name="name_ia"
                                    required
                                    placeholder="Ex: Eletr√¥nicos"
                                    class="mt-1 block w-full rounded-md border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                                <p class="text-xs text-gray-400 mt-1">O nome exatamente como a IA classificar√° o produto.</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700">ID do T√≥pico (Telegram)</label>
                                <input
                                    type="number"
                                    name="thread_id"
                                    required
                                    placeholder="Ex: 102"
                                    class="mt-1 block w-full rounded-md border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                />
                            </div>

                            <button type="submit" class="w-full inline-flex justify-center items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                <i class="fa-solid fa-plus"></i> Salvar Mapeamento
                            </button>
                        </form>
                    </section>

                    <section class="bg-white p-6 rounded-xl shadow border">
                        <h2 class="text-lg font-semibold mb-4">Postagem Manual</h2>
                        <form action="/post-manual" method="POST" class="space-y-3">
                            <textarea
                                name="content"
                                rows="4"
                                placeholder="Cole o link ou a oferta aqui..."
                                class="w-full rounded-md border-gray-200 p-3 resize-none focus:border-orange-400 focus:ring-orange-400"
                            ></textarea>
                            <button class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-md">Postar Agora</button>
                        </form>
                    </section>

                    <section class="bg-white p-6 rounded-xl shadow border">
                        <h2 class="text-lg font-semibold mb-4">Monitorar Canais</h2>
                        <form action="/monitoring" method="POST" class="space-y-3">
                            <input name="channel_id" placeholder="ID do Canal (ex: -100...)" class="w-full rounded-md border-gray-200 p-2" />
                            <input name="channel_name" placeholder="Nome do Canal" class="w-full rounded-md border-gray-200 p-2" />
                            <button class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-md">Adicionar Fonte</button>
                        </form>

                        <ul class="mt-4 space-y-2">
                            <% if (monitored && monitored.length) { %>
                                <% monitored.forEach(m => { %>
                                    <li class="flex items-center justify-between bg-gray-50 rounded p-2 text-sm">
                                        <div class="flex items-center gap-3">
                                            <i class="fa-solid fa-hashtag text-gray-400"></i>
                                            <div>
                                                <div class="font-medium"><%= m.channel_name %></div>
                                                <div class="text-xs text-gray-400">ID: <%= m.channel_id %></div>
                                            </div>
                                        </div>
                                        <a href="/delete-monitoring/<%= m.id %>" class="text-red-500 hover:text-red-700 text-sm">Remover</a>
                                    </li>
                                <% }) %>
                            <% } else { %>
                                <li class="text-sm text-gray-400">Nenhuma fonte de monitoramento cadastrada.</li>
                            <% } %>
                        </ul>
                        <div class="mt-4 pt-4 border-t">
                            <h3 class="text-sm font-medium mb-2">Configura√ß√£o do Grupo</h3>
                            <form id="setGroupChatForm" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">ID do Grupo Principal</label>
                                    <input 
                                        type="text" 
                                        id="groupChatIdInput" 
                                        placeholder="ex: -1003823485865" 
                                        value="<%= groupChatId || '' %>"
                                        class="w-full rounded-md border-gray-200 p-2 text-sm" 
                                    />
                                    <p class="text-xs text-gray-500 mt-1">Obtenha o ID usando /get_chat_id no grupo</p>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded">Salvar ID do Grupo</button>
                            </form>
                            <pre id="groupConfigOutput" class="mt-3 p-3 bg-gray-100 rounded text-xs max-h-32 overflow-auto hidden"></pre>
                        </div>
                    </section>

                    <section class="bg-white p-6 rounded-xl shadow border mt-4">
                        <h2 class="text-lg font-semibold mb-4">Adicionar T√≥picos/Categorias</h2>
                        <p class="text-sm text-gray-600 mb-3">Como a API do Telegram n√£o lista t√≥picos, use os comandos do bot para descobrir os IDs.</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4 text-sm text-blue-800">
                            <p class="font-medium mb-1">üì± Como obter IDs de t√≥picos:</p>
                            <ol class="list-decimal list-inside space-y-1 text-xs">
                                <li>V√° para um t√≥pico no grupo</li>
                                <li>Execute <code>/get_topic_id</code> respondendo a uma mensagem</li>
                                <li>O bot retornar√° o ID do t√≥pico (thread_id)</li>
                                <li>Cole o ID no formul√°rio abaixo</li>
                            </ol>
                        </div>

                        <form id="addTopicForm" class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Nome da Categoria (Exatid√£o em IA)</label>
                                <input 
                                    type="text" 
                                    id="topicName" 
                                    placeholder="ex: Eletr√¥nicos, Promo√ß√µes, etc" 
                                    class="w-full rounded-md border-gray-200 p-2 text-sm" 
                                />
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Thread ID do T√≥pico</label>
                                <input 
                                    type="text" 
                                    id="topicThreadId" 
                                    placeholder="ex: 123456789" 
                                    class="w-full rounded-md border-gray-200 p-2 text-sm" 
                                />
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-2 rounded font-medium">+ Adicionar T√≥pico</button>
                        </form>
                        <pre id="addTopicOutput" class="mt-3 p-3 bg-gray-100 rounded text-xs max-h-32 overflow-auto hidden"></pre>
                    </section>
                </div>

                <!-- Right column: categories -->
                <div class="lg:col-span-2">
                    <section class="bg-white p-6 rounded-xl shadow border">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Categorias e T√≥picos Ativos</h2>
                            <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-sm font-medium">
                                <%= (categories && categories.length) || 0 %> Mapeamentos
                            </span>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase">
                                        <th class="text-left px-4 py-2">Nome na IA</th>
                                        <th class="text-left px-4 py-2">Thread ID (Telegram)</th>
                                        <th class="text-right px-4 py-2">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <% if (!categories || categories.length === 0) { %>
                                        <tr>
                                            <td colspan="3" class="p-6 text-center text-gray-400">Nenhuma categoria cadastrada ainda.</td>
                                        </tr>
                                    <% } else { %>
                                        <% categories.forEach(cat => { %>
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3"> <div class="font-medium"><%= cat.name_ia %></div> </td>
                                                <td class="px-4 py-3"> <div class="text-sm text-gray-600"><%= cat.thread_id %></div> </td>
                                                <td class="px-4 py-3 text-right"> <a href="/delete-category/<%= cat.id %>" class="text-red-500 hover:text-red-700">Excluir</a> </td>
                                            </tr>
                                        <% }) %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 pt-4 border-t">
                            <h3 class="text-sm font-medium mb-2">Diagnosticar IDs do Telegram</h3>
                            <div class="space-y-2 text-xs text-gray-600 mb-3">
                                <p><strong>Como pegar IDs manualmente:</strong></p>
                                <ol class="list-decimal list-inside space-y-1">
                                    <li>No grupo, encaminhe qualquer mensagem para o bot em chat privado</li>
                                    <li>Ou execute <code>/get_thread_id</code> respondendo a uma mensagem do t√≥pico</li>
                                </ol>
                            </div>
                            <button id="getChatInfoBtn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm px-3 py-2 rounded">Testar Status</button>
                            <pre id="chatInfoOutput" class="mt-2 p-2 bg-gray-100 rounded text-xs max-h-32 overflow-auto hidden"></pre>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer class="border-t bg-white mt-8">
            <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500">&copy; 2026 VanBora.AI ‚Äî Ofertas Sert√£o</div>
        </footer>
        <script>
            document.getElementById && (() => {
                // Set group chat ID
                const groupForm = document.getElementById('setGroupChatForm');
                const groupOut = document.getElementById('groupConfigOutput');
                if (groupForm) {
                    groupForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        groupForm.elements[0].disabled = true;
                        groupForm.elements[1].disabled = true;
                        groupOut.classList.remove('hidden');
                        groupOut.textContent = 'Salvando...';
                        try {
                            const groupId = document.getElementById('groupChatIdInput').value.trim();
                            const res = await fetch('/set-group-chat', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ groupChatId: groupId })
                            });
                            const data = await res.json();
                            groupOut.textContent = JSON.stringify(data, null, 2);
                        } catch (err) {
                            groupOut.textContent = 'Erro: ' + (err.message || err);
                        }
                        groupForm.elements[0].disabled = false;
                        groupForm.elements[1].disabled = false;
                    });
                }

                // Add topic/category
                const addTopicForm = document.getElementById('addTopicForm');
                const addTopicOut = document.getElementById('addTopicOutput');
                if (addTopicForm) {
                    addTopicForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        addTopicForm.elements[0].disabled = true;
                        addTopicForm.elements[1].disabled = true;
                        addTopicForm.elements[2].disabled = true;
                        addTopicOut.classList.remove('hidden');
                        addTopicOut.textContent = 'Adicionando...';
                        try {
                            const name = document.getElementById('topicName').value.trim();
                            const threadId = document.getElementById('topicThreadId').value.trim();
                            if (!name || !threadId) {
                                addTopicOut.textContent = 'Erro: Preencha todos os campos';
                                addTopicForm.elements[0].disabled = false;
                                addTopicForm.elements[1].disabled = false;
                                addTopicForm.elements[2].disabled = false;
                                return;
                            }
                            const res = await fetch('/categories', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ name_ia: name, thread_id: parseInt(threadId) })
                            });
                            const data = await res.json();
                            addTopicOut.textContent = data.status === 'ok' ? '‚úÖ T√≥pico adicionado com sucesso!' : 'Resposta: ' + JSON.stringify(data, null, 2);
                            document.getElementById('topicName').value = '';
                            document.getElementById('topicThreadId').value = '';
                            setTimeout(() => window.location.reload(), 1500);
                        } catch (err) {
                            addTopicOut.textContent = 'Erro: ' + (err.message || err);
                        }
                        addTopicForm.elements[0].disabled = false;
                        addTopicForm.elements[1].disabled = false;
                        addTopicForm.elements[2].disabled = false;
                    });
                }

                // Get chat info
                const chatBtn = document.getElementById('getChatInfoBtn');
                const chatOut = document.getElementById('chatInfoOutput');
                if (chatBtn) {
                    chatBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        chatBtn.disabled = true;
                        chatOut.classList.remove('hidden');
                        chatOut.textContent = 'Testando...';
                        try {
                            const res = await fetch('/bot-status');
                            const data = await res.json();
                            chatOut.textContent = JSON.stringify(data, null, 2);
                        } catch (err) {
                            chatOut.textContent = 'Erro: ' + (err.message || err);
                        }
                        chatBtn.disabled = false;
                    });
                }

                // Clear cache function
                window.clearCache = async function() {
                    if (!confirm('Tem certeza que deseja limpar o cache do Redis? Isso permitir√° reenviar promo√ß√µes duplicadas.')) {
                        return;
                    }
                    
                    try {
                        const res = await fetch('/api/clear-cache', { method: 'POST' });
                        const data = await res.json();
                        
                        if (data.status === 'ok') {
                            alert('‚úÖ ' + data.message);
                        } else {
                            alert('‚ùå Erro: ' + (data.error || 'Erro desconhecido'));
                        }
                    } catch (err) {
                        alert('‚ùå Erro ao limpar cache: ' + err.message);
                    }
                };
            })();
        </script>
    </body>
</html>